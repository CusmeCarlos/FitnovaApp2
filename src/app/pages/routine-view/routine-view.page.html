<!-- src/app/pages/routine-view/routine-view.page.html -->

<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/tab3"></ion-back-button>
    </ion-buttons>
    <ion-title>Mi Rutina IA</ion-title>
    
    <ion-buttons slot="end">
      <ion-button 
        fill="clear" 
        (click)="forceSyncManual()"
        [disabled]="loading">
        <ion-icon name="sync-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  
  <!-- Pull to Refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content
      pullingIcon="chevron-down-circle-outline"
      pullingText="Desliza para sincronizar"
      refreshingSpinner="circles"
      refreshingText="Sincronizando rutina...">
    </ion-refresher-content>
  </ion-refresher>

  <!-- Warning de Conexión -->
  <ion-item *ngIf="connectionStatus !== 'connected'" color="warning">
    <ion-icon name="warning-outline" slot="start"></ion-icon>
    <ion-label>
      <h3>Conexión limitada</h3>
      <p>Última sincronización: {{ getConnectionStatusText() }}</p>
    </ion-label>
    <ion-button fill="clear" slot="end" (click)="forceSyncManual()">
      <ion-icon name="refresh-outline"></ion-icon>
    </ion-button>
  </ion-item>

  <!-- Loading -->
  <div *ngIf="shouldShowLoadingSpinner()" class="loading-section">
    <ion-spinner name="circles"></ion-spinner>
    <h3>{{ routineState.status === RoutineStatus.GENERATING ? 'Generando rutina...' : 'Cargando...' }}</h3>
  </div>

  <!-- RUTINA APROBADA -->
  <div *ngIf="shouldShowApprovedActions()" class="routine-container">
    
    <!-- Status Header -->
    <ion-card class="status-card success">
      <ion-card-header>
        <div class="status-icon">
          <ion-icon name="checkmark-circle" color="success"></ion-icon>
        </div>
        <ion-card-title class="status-title">¡Rutina Aprobada!</ion-card-title>
        <ion-card-subtitle>Tu entrenador ha revisado y aprobado tu rutina personalizada.</ion-card-subtitle>
      </ion-card-header>
    </ion-card>

    <!-- Detalles de Rutina -->
    <ion-card class="routine-details">
      <ion-card-header>
        <ion-card-title class="routine-name">{{ getRoutineInfo()?.title || 'Rutina Personalizada' }}</ion-card-title>
        <ion-card-subtitle>{{ getRoutineInfo()?.description || 'Rutina adaptada a tu perfil' }}</ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <!-- Stats Grid -->
        <div class="stats-container">
          <div class="stat-item">
            <ion-icon name="barbell-outline" color="primary"></ion-icon>
            <div class="stat-text">
              <strong>{{ getRoutineInfo()?.exercises || 0 }}</strong>
              <span>Ejercicios</span>
            </div>
          </div>
          
          <div class="stat-item">
            <ion-icon name="time-outline" color="primary"></ion-icon>
            <div class="stat-text">
              <strong>{{ getRoutineInfo()?.duration || '30 min' }}</strong>
              <span>Duración</span>
            </div>
          </div>
          
          <div class="stat-item">
            <ion-icon name="trending-up-outline" color="primary"></ion-icon>
            <div class="stat-text">
              <strong>{{ getRoutineInfo()?.difficulty || 'Principiante' }}</strong>
              <span>Dificultad</span>
            </div>
          </div>
          
          <div class="stat-item">
            <ion-icon name="flame-outline" color="primary"></ion-icon>
            <div class="stat-text">
              <strong>{{ routineState.routine?.routine?.estimatedCalories || 71 }} kcal</strong>
              <span>Calorías</span>
            </div>
          </div>
        </div>

        <!-- Muscle Groups -->
        <div *ngIf="getRoutineInfo()?.muscleGroups?.length > 0" class="muscle-section">
          <h3>
            <ion-icon name="fitness-outline" color="primary"></ion-icon>
            Áreas de enfoque
          </h3>
          <div class="muscle-chips">
            <ion-chip *ngFor="let muscle of getRoutineInfo().muscleGroups" color="primary">
              <ion-label>{{ muscle }}</ion-label>
            </ion-chip>
          </div>
        </div>

        <!-- ⭐ LISTA DE EJERCICIOS DETALLADA ⭐ -->
        <div *ngIf="getRoutineExercises().length > 0" class="exercises-section">
          <h3 class="section-title">
            <ion-icon name="list-outline" color="primary"></ion-icon>
            Ejercicios de la Rutina
          </h3>
          
          <div class="exercises-list">
            <div *ngFor="let exercise of getRoutineExercises(); let i = index" class="exercise-card">
              <div class="exercise-content">
                <!-- Número de orden -->
                <div class="exercise-number">
                  {{i + 1}}
                </div>
                
                <!-- Información del ejercicio -->
                <div class="exercise-info">
                  <h4 class="exercise-name">{{ exercise.name }}</h4>
                  
                  <div class="exercise-details">
                    <span class="detail-badge">
                      <ion-icon name="fitness-outline"></ion-icon>
                      {{ exercise.sets }} series
                    </span>
                    <span class="detail-badge">
                      <ion-icon name="repeat-outline"></ion-icon>
                      {{ exercise.reps || (exercise.duration + 's') }}
                    </span>
                    <span class="detail-badge">
                      <ion-icon name="time-outline"></ion-icon>
                      Descanso: {{ exercise.restTime }}s
                    </span>
                  </div>
                  
                  <!-- Instrucciones -->
                  <div *ngIf="exercise.instructions" class="exercise-instructions">
                    <ion-icon name="information-circle-outline" color="medium"></ion-icon>
                    <p>{{ exercise.instructions }}</p>
                  </div>
                  
                  <!-- Músculos objetivo -->
                  <div *ngIf="exercise.targetMuscles?.length > 0" class="target-muscles">
                    <ion-icon name="body-outline" color="primary"></ion-icon>
                    <span>{{ exercise.targetMuscles.join(', ') }}</span>
                  </div>
                  
                  <!-- Badge de detección de postura -->
                  <ion-chip *ngIf="exercise.hasPoseDetection" color="success" class="detection-badge">
                    <ion-icon name="videocam"></ion-icon>
                    <ion-label>Con análisis de postura</ion-label>
                  </ion-chip>
                  
                  <!-- Modificaciones (si existen) -->
                  <div *ngIf="exercise.modifications" class="exercise-modifications">
                    <ion-icon name="construct-outline" color="warning"></ion-icon>
                    <p><strong>Modificación:</strong> {{ exercise.modifications }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="button-section">
          <ion-button 
            expand="block" 
            size="large"
            (click)="startTraining()"
            [disabled]="loading">
            <ion-icon name="play-outline" slot="start"></ion-icon>
            Comenzar Entrenamiento
          </ion-button>
          
          <ion-button 
            expand="block" 
            fill="outline" 
            size="large"
            (click)="regenerateRoutine()"
            [disabled]="loading">
            <ion-icon name="refresh-outline" slot="start"></ion-icon>
            Generar Nueva Rutina
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- RUTINA ESPERANDO APROBACIÓN -->
  <div *ngIf="shouldShowWaitingMessage()" class="routine-container">
    
    <ion-card class="status-card warning">
      <ion-card-header>
        <div class="status-icon">
          <ion-icon name="time-outline" color="warning"></ion-icon>
        </div>
        <ion-card-title class="status-title">Esperando Aprobación</ion-card-title>
        <ion-card-subtitle>Tu rutina está siendo revisada por tu entrenador.</ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <div class="loading-section">
          <ion-spinner name="dots" color="warning"></ion-spinner>
        </div>

        <!-- Preview si existe -->
        <div *ngIf="getRoutineInfo()" class="preview-section">
          <h4>Vista previa:</h4>
          <ion-item>
            <ion-icon name="fitness-outline" slot="start" color="warning"></ion-icon>
            <ion-label>
              <h3>{{ getRoutineInfo().title }}</h3>
              <p>{{ getRoutineInfo().exercises }} ejercicios • {{ getRoutineInfo().duration }}</p>
            </ion-label>
          </ion-item>
        </div>

        <ion-button 
          expand="block" 
          fill="outline" 
          color="warning"
          (click)="regenerateRoutine()"
          [disabled]="loading">
          <ion-icon name="refresh-outline" slot="start"></ion-icon>
          Generar Nueva Rutina
        </ion-button>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- RUTINA RECHAZADA -->
  <div *ngIf="shouldShowRejectedActions()" class="routine-container">
    
    <ion-card class="status-card danger">
      <ion-card-header>
        <div class="status-icon">
          <ion-icon name="close-circle-outline" color="danger"></ion-icon>
        </div>
        <ion-card-title class="status-title">Rutina Rechazada</ion-card-title>
        <ion-card-subtitle>Tu entrenador ha rechazado la rutina generada.</ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <div *ngIf="routineState.error" class="error-message">
          <h4>Motivo del rechazo:</h4>
          <p>{{ routineState.error }}</p>
        </div>

        <ion-button 
          expand="block" 
          color="danger"
          (click)="regenerateRoutine()"
          [disabled]="loading">
          <ion-icon name="add-outline" slot="start"></ion-icon>
          Generar Nueva Rutina
        </ion-button>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- ERROR EN RUTINA -->
  <div *ngIf="shouldShowErrorActions()" class="routine-container">
    
    <ion-card class="status-card danger">
      <ion-card-header>
        <div class="status-icon">
          <ion-icon name="warning-outline" color="danger"></ion-icon>
        </div>
        <ion-card-title class="status-title">Error en Rutina</ion-card-title>
        <ion-card-subtitle>Hubo un problema con tu rutina.</ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <div *ngIf="routineState.error" class="error-message">
          <p>{{ routineState.error }}</p>
        </div>

        <div class="button-section">
          <ion-button 
            expand="block" 
            color="warning"
            (click)="forceSyncManual()"
            [disabled]="loading">
            <ion-icon name="sync-outline" slot="start"></ion-icon>
            Sincronizar
          </ion-button>
          
          <ion-button 
            expand="block" 
            fill="outline" 
            color="danger"
            (click)="regenerateRoutine()"
            [disabled]="loading">
            <ion-icon name="refresh-outline" slot="start"></ion-icon>
            Generar Nueva Rutina
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- SIN RUTINA -->
  <div *ngIf="routineState.status === RoutineStatus.NONE" class="routine-container">
    
    <ion-card class="status-card medium">
      <ion-card-header>
        <div class="status-icon">
          <ion-icon name="document-outline" color="medium"></ion-icon>
        </div>
        <ion-card-title class="status-title">Sin Rutina</ion-card-title>
        <ion-card-subtitle>No tienes ninguna rutina generada.</ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <ion-button 
          expand="block" 
          routerLink="/tabs/tab3">
          <ion-icon name="add-outline" slot="start"></ion-icon>
          Generar Rutina Ahora
        </ion-button>
      </ion-card-content>
    </ion-card>
  </div>

</ion-content>

<!-- Floating Status -->
<div class="connection-status">
  <ion-chip [color]="connectionStatus === 'connected' ? 'success' : 'warning'">
    <ion-icon name="wifi-outline"></ion-icon>
    <ion-label>{{ getConnectionStatusText() }}</ion-label>
  </ion-chip>
</div>