<!-- src/app/tab1/tab1.page.html - REEMPLAZAR COMPLETO -->
<!-- 📊 TAB1 DASHBOARD CORREGIDO - SIN ERRORES TYPESCRIPT -->

<ion-header [translucent]="true">
  <ion-toolbar color="dark" class="custom-toolbar">
    <ion-title class="custom-title">Dashboard</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" class="refresh-btn" (click)="refreshMetrics()" [disabled]="isLoading">
        <ion-icon name="refresh-outline" [class.spinning]="isLoading"></ion-icon>
      </ion-button>
      <ion-button fill="clear" class="profile-btn" (click)="navigateToProfile()">
        <ion-icon name="person-circle-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="dashboard-content">
  <!-- Background overlay -->
  <div class="background-overlay"></div>
  
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-content">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
      <p>Cargando métricas...</p>
    </div>
  </div>

  <!-- ESTADO VACÍO - PRIMER USO -->
  <div *ngIf="!isLoading && metrics?.isEmpty" class="empty-state-container">
    <div class="empty-state-content">
      <div class="gymshark-brand">
        <img src="assets/gymshark-logo.png" alt="Gymshark" class="gymshark-mini" 
             onerror="this.style.display='none'">
        <span class="powered-text">POWERED BY IA</span>
      </div>
      
      <div class="empty-state-icon">
        <ion-icon name="fitness-outline"></ion-icon>
      </div>
      
      <h1 class="empty-state-title">¡Hola {{ user?.displayName || 'Atleta' }}!</h1>
      <p class="empty-state-subtitle">{{ getMotivationalMessage() }}</p>
      
      <div class="empty-state-tip">
        <ion-icon name="bulb-outline"></ion-icon>
        <span>{{ getTrainingTip() }}</span>
      </div>
      
      <div class="empty-state-actions">
        <ion-button 
          expand="block" 
          color="primary" 
          size="large"
          (click)="navigateToTraining()"
          class="start-training-btn">
          <ion-icon name="play-outline" slot="start"></ion-icon>
          Comenzar Entrenamiento
        </ion-button>
        
        <ion-button 
          fill="outline" 
          color="medium"
          (click)="navigateToProfile()"
          class="setup-profile-btn">
          <ion-icon name="person-outline" slot="start"></ion-icon>
          Configurar Perfil
        </ion-button>
      </div>
      
      <div class="empty-state-features">
        <h3>¿Qué hace nuestra IA?</h3>
        <div class="feature-list">
          <div class="feature-item">
            <ion-icon name="eye-outline"></ion-icon>
            <span>Análisis de postura en tiempo real</span>
          </div>
          <div class="feature-item">
            <ion-icon name="warning-outline"></ion-icon>
            <span>Correcciones instantáneas</span>
          </div>
          <div class="feature-item">
            <ion-icon name="analytics-outline"></ion-icon>
            <span>Seguimiento de progreso</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DASHBOARD CON DATOS REALES -->
  <div *ngIf="!isLoading && metrics && !metrics.isEmpty" class="dashboard-container">
    
    <!-- Welcome Section -->
    <div class="welcome-section">
      <div class="gymshark-brand">
        <img src="assets/gymshark-logo.png" alt="Gymshark" class="gymshark-mini" 
             onerror="this.style.display='none'">
        <span class="powered-text">POWERED BY IA</span>
      </div>
      <h1 class="welcome-title">¡Hola {{ user?.displayName || 'Atleta' }}!</h1>
      <p class="welcome-subtitle">{{ getMotivationalMessage() }}</p>
      <div class="last-updated">
        Actualizado: {{ lastUpdated | date:'short':'es-ES' }}
      </div>
    </div>

    <!-- Main Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card primary" (click)="navigateToTraining()">
        <div class="stat-icon">
          <ion-icon name="fitness-outline"></ion-icon>
        </div>
        <div class="stat-info">
          <span class="stat-number">{{ formatNumber(metrics.totalWorkouts) }}</span>
          <span class="stat-label">Entrenamientos</span>
        </div>
        <div class="stat-trend positive" *ngIf="metrics.weeklyImprovement && metrics.weeklyImprovement > 0">
          <ion-icon name="trending-up-outline"></ion-icon>
        </div>
      </div>

      <div class="stat-card secondary" (click)="openWeeklyHistoryModal()">
        <div class="stat-icon">
          <ion-icon name="checkmark-circle-outline"></ion-icon>
        </div>
        <div class="stat-info">
          <span class="stat-number"
                [style.color]="(currentWeekSummary && currentWeekSummary.totalErrorsReduced > 0) ? '#4caf50' : '#666'">
            {{ (currentWeekSummary && currentWeekSummary.totalErrorsReduced > 0) ? '+' : '' }}{{ currentWeekSummary?.totalErrorsReduced || 0 }}
          </span>
          <span class="stat-label">Errores Reducidos</span>
        </div>
        <div class="stat-badge" [style.background-color]="(currentWeekSummary && currentWeekSummary.totalErrorsReduced > 0) ? '#4caf50' : '#666'">
          Esta Semana
        </div>
      </div>

      <div class="stat-card accent" (click)="navigateToHistory()">
        <div class="stat-icon">
          <ion-icon name="time-outline"></ion-icon>
        </div>
        <div class="stat-info">
          <span class="stat-number">{{ getTotalTimeFormatted() }}</span>
          <span class="stat-label">Tiempo Total</span>
        </div>
      </div>

      <div class="stat-card success" (click)="openWeeklyHistoryModal()">
        <div class="stat-icon">
          <ion-icon name="trending-up-outline"
                    [style.color]="(currentWeekSummary && currentWeekSummary.totalErrorsReduced > 0) ? '#4caf50' : '#ff5722'"></ion-icon>
        </div>
        <div class="stat-info">
          <span class="stat-number"
                [style.color]="(currentWeekSummary && currentWeekSummary.totalErrorsReduced > 0) ? '#4caf50' : '#ff5722'">
            {{ currentWeekSummary?.exerciseCount || 0 }}
          </span>
          <span class="stat-label">Ejercicios Mejorados</span>
        </div>
      </div>
    </div>

    <!-- Historial Semanal - Vista Previa -->
    <div class="section-card history-preview-section">
      <div class="section-header">
        <h3 class="section-title">
          <ion-icon name="calendar-outline"></ion-icon>
          Historial de Errores Semanales
        </h3>
        <ion-button fill="clear" size="small" (click)="openWeeklyHistoryModal()">
          <ion-icon name="eye-outline" slot="start"></ion-icon>
          Más Detalles
        </ion-button>
      </div>

      <!-- Vista previa de últimas 3 semanas -->
      <div class="history-preview-content">
        <div class="preview-weeks" *ngIf="weeklyHistoryPreview && weeklyHistoryPreview.length > 0">
          <div class="preview-week-item"
               *ngFor="let week of weeklyHistoryPreview; let i = index"
               [class.current-week]="i === 0"
               (click)="openWeeklyHistoryModal()">
            <div class="week-info">
              <div class="week-label">
                <ion-icon [name]="i === 0 ? 'star' : 'calendar-outline'"></ion-icon>
                <span>{{ week.weekLabel }}</span>
                <ion-badge *ngIf="i === 0" color="success">Actual</ion-badge>
              </div>
              <div class="week-stats">
                <span class="exercises-count">{{ week.exerciseCount }} ejercicio{{ week.exerciseCount !== 1 ? 's' : '' }}</span>
              </div>
            </div>
            <div class="week-reduction"
                 [style.color]="week.totalErrorsReduced > 0 ? '#4caf50' : '#666'">
              <span class="reduction-value">
                {{ week.totalErrorsReduced > 0 ? '+' : '' }}{{ week.totalErrorsReduced }}
              </span>
              <span class="reduction-unit">errores</span>
            </div>
          </div>
        </div>

        <div class="empty-history" *ngIf="!weeklyHistoryPreview || weeklyHistoryPreview.length === 0">
          <ion-icon name="fitness-outline"></ion-icon>
          <p>Completa 2 sesiones del mismo ejercicio para empezar tu historial</p>
        </div>

        <!-- Indicador de más contenido -->
        <div class="more-indicator" *ngIf="weeklyHistoryPreview && weeklyHistoryPreview.length >= 3">
          <ion-button expand="block" fill="outline" (click)="openWeeklyHistoryModal()">
            <ion-icon name="chevron-down-outline" slot="start"></ion-icon>
            Ver historial completo
            <ion-icon name="chevron-down-outline" slot="end"></ion-icon>
          </ion-button>
        </div>
      </div>
    </div>

    <!-- Progreso por Ejercicio - Reducción de Errores -->
    <div class="section-card exercise-progress-section">
      <div class="section-header">
        <h3 class="section-title">
          <ion-icon name="barbell-outline"></ion-icon>
          Progreso Detallado por Ejercicio
        </h3>
        <div class="section-badge" *ngIf="currentWeekSummary && currentWeekSummary.exercises.length > 0">
          {{ currentWeekSummary.exerciseCount }} ejercicio{{ currentWeekSummary.exerciseCount !== 1 ? 's' : '' }}
        </div>
      </div>

      <!-- Lista de ejercicios con progreso -->
      <div class="exercise-progress-list" *ngIf="currentWeekSummary && currentWeekSummary.exercises.length > 0">
        <div class="exercise-progress-item" *ngFor="let exercise of currentWeekSummary.exercises">
          <div class="exercise-header">
            <div class="exercise-title">
              <ion-icon name="fitness-outline"></ion-icon>
              <h4>{{ exercise.exerciseName }}</h4>
            </div>
            <div class="exercise-result"
                 [style.color]="exercise.errorReduction > 0 ? '#4caf50' : exercise.errorReduction < 0 ? '#ff5722' : '#ff9800'">
              <span class="result-value">
                {{ exercise.errorReduction > 0 ? '+' : '' }}{{ exercise.errorReduction }}
              </span>
              <span class="result-label">errores</span>
            </div>
          </div>

          <div class="exercise-comparison">
            <div class="session-box session-1">
              <div class="session-label">Sesión 1</div>
              <div class="session-errors">{{ exercise.session1Errors }}</div>
              <div class="session-subtitle">errores</div>
            </div>

            <div class="comparison-arrow">
              <ion-icon name="arrow-forward-outline"></ion-icon>
            </div>

            <div class="session-box session-2">
              <div class="session-label">Sesión 2</div>
              <div class="session-errors">{{ exercise.session2Errors }}</div>
              <div class="session-subtitle">errores</div>
            </div>
          </div>

          <!-- Barra de progreso visual -->
          <div class="progress-visualization">
            <div class="progress-bar-comparison">
              <div class="bar session-1-bar"
                   [style.width.%]="getErrorPercentage(exercise.session1Errors, exercise)">
                <span>{{ exercise.session1Errors }}</span>
              </div>
              <div class="bar session-2-bar"
                   [style.width.%]="getErrorPercentage(exercise.session2Errors, exercise)">
                <span>{{ exercise.session2Errors }}</span>
              </div>
            </div>
            <div class="progress-labels">
              <span>S1</span>
              <span>S2</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Estado vacío cuando no hay ejercicios -->
      <div class="empty-exercise-progress" *ngIf="!currentWeekSummary || currentWeekSummary.exercises.length === 0">
        <ion-icon name="barbell-outline"></ion-icon>
        <h4>Completa 2 sesiones del mismo ejercicio</h4>
        <p>Aquí verás una comparación detallada entre tu primera y segunda sesión, mostrando cuántos errores redujiste.</p>
        <ion-button fill="outline" (click)="navigateToTraining()">
          <ion-icon name="add-circle-outline" slot="start"></ion-icon>
          Comenzar Entrenamiento
        </ion-button>
      </div>
    </div>

    <!-- Exercise Stats Section -->
    <div class="section-card" *ngIf="metrics.exerciseStats && metrics.exerciseStats.length > 0">
      <div class="section-header">
        <h3 class="section-title">
          <ion-icon name="barbell-outline"></ion-icon>
          Estadísticas por Ejercicio
        </h3>
      </div>

      <div class="exercise-stats">
        <div class="exercise-item" *ngFor="let exercise of metrics.exerciseStats">
          <div class="exercise-info">
            <h4>{{ exercise.exercise }}</h4>
            <span>{{ exercise.count }} sesiones</span>
          </div>
          <div class="exercise-accuracy">
            <div class="accuracy-circle" 
                 [style.background]="'conic-gradient(#4caf50 ' + exercise.avgAccuracy + '%, #2a2a2a 0)'">
              <span>{{ formatAccuracy(exercise.avgAccuracy) }}%</span>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- Recent Alerts Section -->
    <div class="section-card" *ngIf="metrics.recentAlerts && metrics.recentAlerts.length > 0">
      <div class="section-header">
        <h3 class="section-title">
          <ion-icon name="notifications-outline"></ion-icon>
          Alertas Recientes
        </h3>
        <div class="section-badge">
          {{ metrics.recentAlerts.length || 0 }} alertas
        </div>
      </div>

      <div class="alerts-list">
        <div class="alert-item" 
             *ngFor="let alert of metrics.recentAlerts.slice(0, 3); trackBy: trackAlert">
          <div class="alert-icon" [class]="'severity-' + alert.severity">
            <ion-icon name="warning-outline"></ion-icon>
          </div>
          <div class="alert-content">
            <h4>{{ getErrorTypeLabel(alert.errorType) }}</h4>
            <p>{{ alert.exercise }} - {{ alert.processedAt | date:'short':'es-ES' }}</p>
            <div class="alert-confidence">
              Confianza: {{ getConfidencePercentage(alert.confidence) }}%
            </div>
          </div>
        </div>
      </div>

      <ion-button
        fill="outline"
        expand="block"
        color="medium"
        (click)="viewAllAlerts()"
        class="view-all-alerts-premium">
        <ion-icon name="alert-circle-outline" slot="start"></ion-icon>
        Ver Todas las Alertas
        <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
      </ion-button>
    </div>

    <!-- Error Analysis Section - PREMIUM BLUE -->
    <div class="section-card error-analysis-premium" *ngIf="hasErrorsByType(metrics)">
      <div class="section-header">
        <h3 class="section-title gradient-blue">
          <ion-icon name="analytics-outline"></ion-icon>
          Análisis de Errores
        </h3>
        <div class="section-badge blue-badge">
          {{ metrics.criticalErrorsToday || 0 }} hoy
        </div>
      </div>

      <div class="error-analysis">
        <div class="most-common-error premium-error-card" *ngIf="metrics.mostCommonError">
          <div class="error-icon-wrapper">
            <ion-icon name="alert-circle-outline"></ion-icon>
          </div>
          <h4>ERROR MÁS COMÚN</h4>
          <h3 class="error-title">{{ getErrorTypeLabel(metrics.mostCommonError) }}</h3>
          <p class="error-tip">
            <ion-icon name="bulb-outline"></ion-icon>
            {{ getTrainingTip() }}
          </p>
        </div>

        <div class="chart-container premium-chart">
          <h4>DISTRIBUCIÓN DE ERRORES</h4>
          <div class="chart-wrapper">
            <canvas #errorsChart></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions - PREMIUM BLUE -->
    <div class="quick-actions">
      <ion-button
        expand="block"
        color="primary"
        size="large"
        (click)="navigateToTraining()"
        class="action-button premium-train-button">
        <ion-icon name="play-circle-outline" slot="start"></ion-icon>
        ENTRENAR AHORA
        <ion-icon name="arrow-forward-outline" slot="end"></ion-icon>
      </ion-button>

      <div class="action-row">
        <ion-button
          fill="outline"
          color="primary"
          (click)="navigateToHistory()"
          class="action-button-small premium-action-btn">
          <ion-icon name="time-outline" slot="start"></ion-icon>
          Historial
        </ion-button>

        <ion-button
          fill="outline"
          color="danger"
          (click)="resetDashboard()"
          class="action-button-small premium-action-btn">
          <ion-icon name="refresh-outline" slot="start"></ion-icon>
          Reset
        </ion-button>
      </div>
    </div>
         <!-- 🆕 BOTÓN TEMPORAL DE RESET -->
         <ion-button 
         fill="outline" 
         color="danger"
         size="small"
         (click)="resetDashboard()"
         class="action-button-small"
         style="margin-top: 1rem;">
         <ion-icon name="refresh-outline" slot="start"></ion-icon>
         Reset Dashboard
       </ion-button>

  </div>

</ion-content>