<!-- src/app/tab1/tab1.page.html - REEMPLAZAR COMPLETO -->
<!-- üìä TAB1 DASHBOARD CORREGIDO - SIN ERRORES TYPESCRIPT -->

<ion-header [translucent]="true">
  <ion-toolbar color="dark" class="custom-toolbar">
    <ion-title class="custom-title">Dashboard</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" class="refresh-btn" (click)="refreshMetrics()" [disabled]="isLoading">
        <ion-icon name="refresh-outline" [class.spinning]="isLoading"></ion-icon>
      </ion-button>
      <ion-button fill="clear" class="profile-btn" (click)="navigateToProfile()">
        <ion-icon name="person-circle-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="dashboard-content">
  <!-- Background overlay -->
  <div class="background-overlay"></div>
  
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-content">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
      <p>Cargando m√©tricas...</p>
    </div>
  </div>

  <!-- ESTADO VAC√çO - PRIMER USO -->
  <div *ngIf="!isLoading && metrics?.isEmpty" class="empty-state-container">
    <div class="empty-state-content">
      <div class="gymshark-brand">
        <img src="assets/gymshark-logo.png" alt="Gymshark" class="gymshark-mini" 
             onerror="this.style.display='none'">
        <span class="powered-text">POWERED BY IA</span>
      </div>
      
      <div class="empty-state-icon">
        <ion-icon name="fitness-outline"></ion-icon>
      </div>
      
      <h1 class="empty-state-title">¬°Hola {{ user?.displayName || 'Atleta' }}!</h1>
      <p class="empty-state-subtitle">{{ getMotivationalMessage() }}</p>
      
      <div class="empty-state-tip">
        <ion-icon name="bulb-outline"></ion-icon>
        <span>{{ getTrainingTip() }}</span>
      </div>
      
      <div class="empty-state-actions">
        <ion-button 
          expand="block" 
          color="primary" 
          size="large"
          (click)="navigateToTraining()"
          class="start-training-btn">
          <ion-icon name="play-outline" slot="start"></ion-icon>
          Comenzar Entrenamiento
        </ion-button>
        
        <ion-button 
          fill="outline" 
          color="medium"
          (click)="navigateToProfile()"
          class="setup-profile-btn">
          <ion-icon name="person-outline" slot="start"></ion-icon>
          Configurar Perfil
        </ion-button>
      </div>
      
      <div class="empty-state-features">
        <h3>¬øQu√© hace nuestra IA?</h3>
        <div class="feature-list">
          <div class="feature-item">
            <ion-icon name="eye-outline"></ion-icon>
            <span>An√°lisis de postura en tiempo real</span>
          </div>
          <div class="feature-item">
            <ion-icon name="warning-outline"></ion-icon>
            <span>Correcciones instant√°neas</span>
          </div>
          <div class="feature-item">
            <ion-icon name="analytics-outline"></ion-icon>
            <span>Seguimiento de progreso</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DASHBOARD CON DATOS REALES -->
  <div *ngIf="!isLoading && metrics && !metrics.isEmpty" class="dashboard-container">
    
    <!-- Welcome Section -->
    <div class="welcome-section">
      <div class="gymshark-brand">
        <img src="assets/gymshark-logo.png" alt="Gymshark" class="gymshark-mini" 
             onerror="this.style.display='none'">
        <span class="powered-text">POWERED BY IA</span>
      </div>
      <h1 class="welcome-title">¬°Hola {{ user?.displayName || 'Atleta' }}!</h1>
      <p class="welcome-subtitle">{{ getMotivationalMessage() }}</p>
      <div class="last-updated">
        Actualizado: {{ lastUpdated | date:'short':'es-ES' }}
      </div>
    </div>

    <!-- Main Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card primary" (click)="navigateToTraining()">
        <div class="stat-icon">
          <ion-icon name="fitness-outline"></ion-icon>
        </div>
        <div class="stat-info">
          <span class="stat-number">{{ formatNumber(metrics.totalWorkouts) }}</span>
          <span class="stat-label">Entrenamientos</span>
        </div>
        <div class="stat-trend positive" *ngIf="metrics.weeklyImprovement && metrics.weeklyImprovement > 0">
          <ion-icon name="trending-up-outline"></ion-icon>
        </div>
      </div>

      <div class="stat-card secondary" (click)="navigateToProfile()">
        <div class="stat-icon">
          <ion-icon name="analytics-outline"></ion-icon>
        </div>
        <div class="stat-info">
          <span class="stat-number">{{ metrics.accuracy }}%</span>
          <span class="stat-label">Precisi√≥n</span>
        </div>
        <div class="stat-badge" [style.background-color]="getAccuracyBadgeColor(metrics.accuracy)">
          {{ getAccuracyBadgeText(metrics.accuracy) }}
        </div>
      </div>

      <div class="stat-card accent" (click)="navigateToHistory()">
        <div class="stat-icon">
          <ion-icon name="time-outline"></ion-icon>
        </div>
        <div class="stat-info">
          <span class="stat-number">{{ getTotalTimeFormatted() }}</span>
          <span class="stat-label">Tiempo Total</span>
        </div>
      </div>

      <div class="stat-card success">
        <div class="stat-icon">
          <ion-icon name="trending-up-outline" 
                    [style.color]="getImprovementColor(metrics.weeklyImprovement)"></ion-icon>
        </div>
        <div class="stat-info">
          <span class="stat-number" 
                [style.color]="getImprovementColor(metrics.weeklyImprovement)">
            {{ getImprovementText(metrics.weeklyImprovement) }}
          </span>
          <span class="stat-label">Mejora Semanal</span>
        </div>
      </div>
    </div>

    <!-- Weekly Progress Section -->
    <div class="section-card">
      <div class="section-header">
        <h3 class="section-title">
          <ion-icon name="calendar-outline"></ion-icon>
          Tu Progreso Semanal
        </h3>
        <div class="section-badge">
          {{ (metrics.weeklyGoalProgress | number:'1.0-0') || 0 }}% completado
        </div>
      </div>

      <div class="weekly-goal">
        <div class="goal-header">
          <span>Objetivo Semanal</span>
          <span>{{ getCompletedDaysCount() }}/5 d√≠as</span>
        </div>
        
        <div class="goal-progress">
          <div class="progress-bar">
            <div class="progress-fill" 
                 [style.width.%]="metrics.weeklyGoalProgress || 0">
            </div>
          </div>
        </div>

        <div class="goal-days">
          <div class="day-item" 
               *ngFor="let day of weeklyGoalDays" 
               [class.completed]="day.completed">
            <span class="day-letter">{{ day.label }}</span>
          </div>
        </div>
      </div>

      <!-- Chart Container -->
      <div class="chart-container" *ngIf="metrics.weeklyProgress">
        <h4>Entrenamientos vs Errores</h4>
        <div class="chart-wrapper">
          <canvas #progressChart></canvas>
        </div>
      </div>
    </div>

    <!-- Exercise Stats Section -->
    <div class="section-card" *ngIf="metrics.exerciseStats && metrics.exerciseStats.length > 0">
      <div class="section-header">
        <h3 class="section-title">
          <ion-icon name="barbell-outline"></ion-icon>
          Estad√≠sticas por Ejercicio
        </h3>
      </div>

      <div class="exercise-stats">
        <div class="exercise-item" *ngFor="let exercise of metrics.exerciseStats">
          <div class="exercise-info">
            <h4>{{ exercise.exercise }}</h4>
            <span>{{ exercise.count }} sesiones</span>
          </div>
          <div class="exercise-accuracy">
            <div class="accuracy-circle" 
                 [style.background]="'conic-gradient(#4caf50 ' + exercise.avgAccuracy + '%, #2a2a2a 0)'">
              <span>{{ exercise.avgAccuracy }}%</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Accuracy Trend Section -->
    <div class="section-card" *ngIf="metrics.accuracyTrend">
      <div class="section-header">
        <h3 class="section-title">
          <ion-icon name="trending-up-outline"></ion-icon>
          Tendencia de Precisi√≥n
        </h3>
        <div class="section-badge">
          {{ metrics.accuracy }}% promedio
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-wrapper">
          <canvas #accuracyChart></canvas>
        </div>
      </div>
    </div>

    <!-- Recent Alerts Section -->
    <div class="section-card" *ngIf="metrics.recentAlerts && metrics.recentAlerts.length > 0">
      <div class="section-header">
        <h3 class="section-title">
          <ion-icon name="notifications-outline"></ion-icon>
          Alertas Recientes
        </h3>
        <div class="section-badge">
          {{ metrics.recentAlerts.length || 0 }} alertas
        </div>
      </div>

      <div class="alerts-list">
        <div class="alert-item" 
             *ngFor="let alert of metrics.recentAlerts.slice(0, 3); trackBy: trackAlert">
          <div class="alert-icon" [class]="'severity-' + alert.severity">
            <ion-icon name="warning-outline"></ion-icon>
          </div>
          <div class="alert-content">
            <h4>{{ getErrorTypeLabel(alert.errorType) }}</h4>
            <p>{{ alert.exercise }} - {{ alert.processedAt | date:'short':'es-ES' }}</p>
            <div class="alert-confidence">
              Confianza: {{ getConfidencePercentage(alert.confidence) }}%
            </div>
          </div>
        </div>
      </div>

      <ion-button 
        fill="outline" 
        expand="block" 
        color="medium"
        (click)="viewAllAlerts()"
        class="view-all-btn">
        Ver Todas las Alertas
      </ion-button>
    </div>

    <!-- Error Analysis Section -->
    <div class="section-card" *ngIf="hasErrorsByType(metrics)">
      <div class="section-header">
        <h3 class="section-title">
          <ion-icon name="analytics-outline"></ion-icon>
          An√°lisis de Errores
        </h3>
        <div class="section-badge">
          {{ metrics.criticalErrorsToday || 0 }} hoy
        </div>
      </div>

      <div class="error-analysis">
        <div class="most-common-error" *ngIf="metrics.mostCommonError">
          <h4>ERROR M√ÅS COM√öN</h4>
          <h3 class="error-title">{{ getErrorTypeLabel(metrics.mostCommonError) }}</h3>
          <p class="error-tip">{{ getTrainingTip() }}</p>
        </div>

        <div class="chart-container">
          <h4>Distribuci√≥n de Errores</h4>
          <div class="chart-wrapper">
            <canvas #errorsChart></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
      <ion-button 
        expand="block" 
        color="primary" 
        size="large"
        (click)="navigateToTraining()"
        class="action-button">
        <ion-icon name="play-outline" slot="start"></ion-icon>
        Entrenar Ahora
      </ion-button>

      <div class="action-row">
        <ion-button 
          fill="outline" 
          color="medium"
          (click)="navigateToHistory()"
          class="action-button-small">
          <ion-icon name="time-outline" slot="start"></ion-icon>
          Historial
        </ion-button>

        <ion-button 
          fill="outline" 
          color="medium"
          (click)="navigateToProfile()"
          class="action-button-small">
          <ion-icon name="person-outline" slot="start"></ion-icon>
          Perfil
        </ion-button>
      </div>
    </div>
         <!-- üÜï BOT√ìN TEMPORAL DE RESET -->
         <ion-button 
         fill="outline" 
         color="danger"
         size="small"
         (click)="resetDashboard()"
         class="action-button-small"
         style="margin-top: 1rem;">
         <ion-icon name="refresh-outline" slot="start"></ion-icon>
         Reset Dashboard
       </ion-button>

  </div>

</ion-content>