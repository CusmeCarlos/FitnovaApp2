<!-- src/app/tab3/tab3.page.html -->
<!-- ‚úÖ TAB3 COMPLETO CON RUTINAS ADAPTATIVAS IA -->

<ion-header [translucent]="true">
  <ion-toolbar color="dark" class="custom-toolbar">
    <ion-title class="custom-title">Mi Perfil</ion-title>
    <ion-buttons slot="end">
      <ion-button 
        fill="clear" 
        class="ai-progress-btn" 
        (click)="showAIProgress()" 
        [color]="isAIReady ? 'success' : 'warning'">
        <ion-icon name="brain-outline"></ion-icon>
      </ion-button>
      <ion-button fill="clear" class="logout-btn" (click)="logout()">
        <ion-icon name="log-out-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="profile-content">
  <!-- Background overlay -->
  <div class="background-overlay"></div>
    <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Mi Perfil</ion-title>
    </ion-toolbar>
  </ion-header>

  <div class="container">
    <!-- Header Section -->
    <div class="header-section">
      <div class="profile-info">
        <div class="avatar-section" (click)="changeAvatar()">
          <img 
            [src]="user?.photoURL || 'assets/avatar-placeholder.png'" 
            alt="Avatar"
            class="profile-avatar">
          <div class="avatar-overlay">
            <ion-icon name="camera-outline"></ion-icon>
          </div>
        </div>
        <div class="user-details">
          <h2>{{ user?.displayName || 'Usuario' }}</h2>
          <p>{{ user?.email }}</p>
          <ion-chip 
            [color]="user?.emailVerified ? 'success' : 'warning'"
            (click)="!user?.emailVerified && sendEmailVerification()">
            <ion-icon [name]="user?.emailVerified ? 'checkmark-circle' : 'alert-circle'"></ion-icon>
            <ion-label>{{ user?.emailVerified ? 'Verificado' : 'Verificar email' }}</ion-label>
          </ion-chip>
        </div>
      </div>
    </div>

    <!-- Progress Bars Section -->
    <div class="progress-section" *ngIf="profile">
      <!-- Progreso General -->
      <div class="progress-header">
        <h3>Perfil Completado</h3>
        <span class="progress-percentage">{{ profileCompletionPercentage }}%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="profileCompletionPercentage"></div>
      </div>
      
      <!-- ‚úÖ PROGRESO PARA IA -->
      <div class="progress-header ai-progress">
        <h3>
          <ion-icon name="brain-outline" [color]="isAIReady ? 'success' : 'warning'"></ion-icon>
          Preparaci√≥n para IA
        </h3>
        <span class="progress-percentage" [ngClass]="{'ready': isAIReady}">{{ aiReadinessPercentage }}%</span>
      </div>
      <div class="progress-bar ai-bar">
        <div 
          class="progress-fill ai-fill" 
          [style.width.%]="aiReadinessPercentage"
          [ngClass]="{'ready': isAIReady}">
        </div>
      </div>
      <p class="progress-description ai-description" [ngClass]="{'ready': isAIReady}">
        {{ isAIReady ? 
            '‚úÖ Listo para generar rutinas personalizadas' : 
            '‚ö†Ô∏è Completa la informaci√≥n para rutinas IA' }}
      </p>
    </div>

    <!-- ‚úÖ BOT√ìN GENERAR RUTINA IA -->
    <div class="ai-action-section" *ngIf="isAIReady && !isGeneratingRoutine">
      <ion-button 
        expand="block" 
        color="secondary" 
        size="large"
        (click)="generateAIRoutine()"
        class="ai-generate-button">
        <ion-icon name="brain-outline" slot="start"></ion-icon>
        üèãÔ∏è Generar Rutina con IA
      </ion-button>
    </div>

    <!-- Bot√≥n Ver Rutina (solo si existe rutina) -->
      <ion-button
      *ngIf="hasActiveRoutine()"
      expand="block"
      fill="outline"
      color="success"
      (click)="viewCurrentRoutine()"
      class="profile-button view-routine-btn">
      <ion-icon name="fitness-outline" slot="start"></ion-icon>
      Ver Mi Rutina IA
      </ion-button>


    <!-- ‚úÖ LOADING ESTADO GENERANDO RUTINA -->
    <div class="ai-action-section" *ngIf="isGeneratingRoutine">
      <ion-button 
        expand="block" 
        color="secondary" 
        size="large"
        disabled="true"
        class="ai-generating-button">
        <ion-spinner slot="start"></ion-spinner>
        üß† Generando rutina personalizada...
      </ion-button>
    </div>

    

    <!-- Section Navigation -->
    <div class="section-navigation">
      <div class="nav-container">
        
        <!-- Personal -->
        <div 
          class="nav-tab" 
          [class.active]="currentSection === 'personal'"
          (click)="changeSection('personal')">
          <div class="nav-icon-wrapper">
            <ion-icon name="person" class="nav-icon"></ion-icon>
            <div class="nav-indicator"></div>
          </div>
          <span class="nav-label">Personal</span>
          <div class="nav-step">1</div>
        </div>

        <!-- M√©dico -->
        <div 
          class="nav-tab" 
          [class.active]="currentSection === 'medical'"
          [class.ai-critical]="currentSection === 'medical'"
          (click)="changeSection('medical')">
          <div class="nav-icon-wrapper">
            <ion-icon name="medical" class="nav-icon"></ion-icon>
            <div class="nav-indicator"></div>
          </div>
          <span class="nav-label">M√©dico</span>
          <div class="nav-step">2</div>
          <ion-icon name="brain-outline" class="ai-indicator" *ngIf="currentSection === 'medical'"></ion-icon>
        </div>

        <!-- Objetivos -->
        <div 
          class="nav-tab" 
          [class.active]="currentSection === 'goals'"
          (click)="changeSection('goals')">
          <div class="nav-icon-wrapper">
            <ion-icon name="trophy" class="nav-icon"></ion-icon>
            <div class="nav-indicator"></div>
          </div>
          <span class="nav-label">Objetivos</span>
          <div class="nav-step">3</div>
        </div>

        <!-- Nivel -->
        <div 
          class="nav-tab" 
          [class.active]="currentSection === 'level'"
          (click)="changeSection('level')">
          <div class="nav-icon-wrapper">
            <ion-icon name="barbell" class="nav-icon"></ion-icon>
            <div class="nav-indicator"></div>
          </div>
          <span class="nav-label">Nivel</span>
          <div class="nav-step">4</div>
        </div>

        <!-- Preferencias -->
        <div 
          class="nav-tab" 
          [class.active]="currentSection === 'preferences'"
          (click)="changeSection('preferences')">
          <div class="nav-icon-wrapper">
            <ion-icon name="settings" class="nav-icon"></ion-icon>
            <div class="nav-indicator"></div>
          </div>
          <span class="nav-label">Preferencias</span>
          <div class="nav-step">5</div>
        </div>

      </div>
    </div>

    <!-- ===== SECCI√ìN INFORMACI√ìN PERSONAL ===== -->
    <ion-card *ngIf="currentSection === 'personal'" class="section-card">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="person-outline"></ion-icon>
          Informaci√≥n Personal
        </ion-card-title>
      </ion-card-header>
      
      <ion-card-content>
        <form [formGroup]="personalInfoForm" (ngSubmit)="savePersonalInfo()">
          
          <div class="form-section">
            <h4>Datos B√°sicos</h4>
            
            <ion-item class="form-item">
              <ion-label position="stacked">Edad *</ion-label>
              <ion-input 
                formControlName="age" 
                type="number" 
                placeholder="Ej: 25"
                min="13" 
                max="100">
              </ion-input>
            </ion-item>

            <ion-item class="form-item">
              <ion-label position="stacked">G√©nero *</ion-label>
              <ion-select formControlName="gender" placeholder="Selecciona tu g√©nero">
                <ion-select-option 
                  *ngFor="let option of genderOptions" 
                  [value]="option.value">
                  {{ option.label }}
                </ion-select-option>
              </ion-select>
            </ion-item>

            <div class="form-row">
              <ion-item class="form-item half">
                <ion-label position="stacked">Peso (kg) *</ion-label>
                <ion-input 
                  formControlName="weight" 
                  type="number" 
                  placeholder="Ej: 70"
                  min="30" 
                  max="300">
                </ion-input>
              </ion-item>

              <ion-item class="form-item half">
                <ion-label position="stacked">Altura (cm) *</ion-label>
                <ion-input 
                  formControlName="height" 
                  type="number" 
                  placeholder="Ej: 170"
                  min="100" 
                  max="250">
                </ion-input>
              </ion-item>
            </div>

            <!-- FECHA DE NACIMIENTO SIMPLE -->
            <ion-item class="form-item">
              <ion-label position="stacked">Fecha de Nacimiento</ion-label>
              <ion-input 
                formControlName="dateOfBirth" 
                type="date"
                [max]="maxDate.split('T')[0]"
                placeholder="DD/MM/AAAA">
              </ion-input>
            </ion-item>

            <ion-item class="form-item">
              <ion-label position="stacked">Tel√©fono</ion-label>
              <ion-input 
                formControlName="phoneNumber" 
                type="tel" 
                placeholder="Ej: +593 99 123 4567">
              </ion-input>
            </ion-item>
          </div>

          <!-- Contacto de Emergencia -->
          <div class="form-section" formGroupName="emergencyContact">
            <h4>Contacto de Emergencia</h4>
            
            <ion-item class="form-item">
              <ion-label position="stacked">Nombre</ion-label>
              <ion-input 
                formControlName="name" 
                placeholder="Nombre del contacto de emergencia">
              </ion-input>
            </ion-item>

            <ion-item class="form-item">
              <ion-label position="stacked">Tel√©fono</ion-label>
              <ion-input 
                formControlName="phone" 
                type="tel" 
                placeholder="Tel√©fono del contacto">
              </ion-input>
            </ion-item>

            <ion-item class="form-item">
              <ion-label position="stacked">Relaci√≥n</ion-label>
              <ion-select formControlName="relationship" placeholder="Tipo de relaci√≥n">
                <ion-select-option 
                  *ngFor="let relation of relationshipOptions" 
                  [value]="relation">
                  {{ relation }}
                </ion-select-option>
              </ion-select>
            </ion-item>
          </div>

          <div class="form-actions">
            <ion-button 
              type="submit" 
              expand="block" 
              [disabled]="personalInfoForm.invalid || isSaving">
              {{ isSaving ? 'Guardando...' : 'Guardar Informaci√≥n Personal' }}
              <ion-spinner *ngIf="isSaving" slot="end"></ion-spinner>
            </ion-button>
          </div>
        </form>
      </ion-card-content>
    </ion-card>

    <!-- ===== SECCI√ìN HISTORIAL M√âDICO (EXPANDIDA PARA IA) ===== -->
    <ion-card *ngIf="currentSection === 'medical'" class="section-card medical-card">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="medical-outline"></ion-icon>
          Historial M√©dico Completo
          <ion-chip color="warning" size="small">
            <ion-icon name="brain-outline"></ion-icon>
            <ion-label>Cr√≠tico para IA</ion-label>
          </ion-chip>
        </ion-card-title>
      </ion-card-header>
      
      <ion-card-content>
        <form [formGroup]="medicalHistoryForm" (ngSubmit)="saveMedicalHistory()">
          
          <!-- ‚úÖ SECCI√ìN CR√çTICA PARA IA: LESIONES Y LIMITACIONES ACTUALES -->
          <div class="form-section critical-section">
            <h4>
              <ion-icon name="warning-outline" color="danger"></ion-icon>
              Limitaciones Actuales (Cr√≠tico para IA)
            </h4>
            <div class="critical-notice">
              <p>Esta informaci√≥n es fundamental para que la IA genere rutinas seguras y personalizadas.</p>
            </div>

            <!-- Lesiones Actuales -->
            <ion-item class="form-item">
              <ion-label position="stacked">¬øTienes alguna lesi√≥n actual o dolor cr√≥nico?</ion-label>
              <ion-textarea 
                formControlName="currentInjuries" 
                placeholder="Describe cualquier dolor, molestia o lesi√≥n que tengas actualmente..."
                rows="3">
              </ion-textarea>
            </ion-item>

            <!-- √Åreas con Dolor -->
            <div class="body-areas-section">
              <ion-label class="section-label">¬øQu√© partes del cuerpo te duelen o molestan?</ion-label>
              <div class="body-areas-grid">
                <ion-item class="body-area-item" *ngFor="let area of bodyAreas">
                  <ion-checkbox 
                    [checked]="selectedBodyAreas.includes(area.value)"
                    (ionChange)="onBodyAreaChange($event, area.value)">
                  </ion-checkbox>
                  <ion-label class="body-area-label">
                    <ion-icon [name]="area.icon" [color]="area.color"></ion-icon>
                    {{ area.label }}
                  </ion-label>
                </ion-item>
              </div>
            </div>

            <!-- Ejercicios Prohibidos por M√©dico -->
            <ion-item class="form-item">
              <ion-label position="stacked">¬øHay ejercicios que tu m√©dico te ha prohibido?</ion-label>
              <ion-textarea 
                formControlName="forbiddenExercises" 
                placeholder="Ej: No puedo hacer sentadillas, mi m√©dico me prohibi√≥ levantar peso..."
                rows="3">
              </ion-textarea>
            </ion-item>

            <!-- Limitaciones de Movimiento -->
            <ion-item class="form-item">
              <ion-label position="stacked">¬øHay movimientos que no puedes hacer o te causan dolor?</ion-label>
              <ion-textarea 
                formControlName="movementLimitations" 
                placeholder="Ej: No puedo doblar completamente las rodillas, me duele rotar el hombro..."
                rows="3">
              </ion-textarea>
            </ion-item>

            <!-- Ejercicios a Evitar -->
            <ion-item class="form-item">
              <ion-label position="stacked">¬øHay ejercicios espec√≠ficos que debes evitar?</ion-label>
              <ion-textarea 
                formControlName="exercisesToAvoid" 
                placeholder="Ej: Peso muerto, burpees, cualquier ejercicio de impacto..."
                rows="3">
              </ion-textarea>
            </ion-item>
          </div>

          <!-- ‚úÖ SECCI√ìN CR√çTICA PARA IA: CAPACIDAD F√çSICA ACTUAL -->
          <div class="form-section capacity-section">
            <h4>
              <ion-icon name="fitness-outline" color="primary"></ion-icon>
              Capacidad F√≠sica Actual (Cr√≠tico para IA)
            </h4>

            <!-- Capacidad Cardiovascular -->
            <ion-item class="form-item">
              <ion-label position="stacked">¬øCu√°nto tiempo puedes caminar sin cansarte? *</ion-label>
              <ion-select formControlName="walkingCapacity" placeholder="Selecciona tu nivel">
                <ion-select-option value="less_5min">Menos de 5 minutos</ion-select-option>
                <ion-select-option value="5_15min">Entre 5-15 minutos</ion-select-option>
                <ion-select-option value="15_30min">Entre 15-30 minutos</ion-select-option>
                <ion-select-option value="30_60min">Entre 30-60 minutos</ion-select-option>
                <ion-select-option value="more_60min">M√°s de 60 minutos</ion-select-option>
              </ion-select>
            </ion-item>

            <!-- Capacidad de Escaleras -->
            <ion-item class="form-item">
              <ion-label position="stacked">¬øPuedes subir escaleras sin dificultad? *</ion-label>
              <ion-select formControlName="stairsCapacity" placeholder="Selecciona">
                <ion-select-option value="no_difficulty">Sin ninguna dificultad</ion-select-option>
                <ion-select-option value="mild_difficulty">Con poca dificultad</ion-select-option>
                <ion-select-option value="moderate_difficulty">Con dificultad moderada</ion-select-option>
                <ion-select-option value="high_difficulty">Con mucha dificultad</ion-select-option>
                <ion-select-option value="cannot">No puedo subir escaleras</ion-select-option>
              </ion-select>
            </ion-item>

            <!-- Experiencia con Pesas -->
            <ion-item class="form-item">
              <ion-label position="stacked">¬øHas levantado pesas antes? *</ion-label>
              <ion-select formControlName="weightExperience" placeholder="Selecciona">
                <ion-select-option value="never">Nunca he levantado pesas</ion-select-option>
                <ion-select-option value="few_times">Solo unas pocas veces</ion-select-option>
                <ion-select-option value="some_experience">Tengo algo de experiencia</ion-select-option>
                <ion-select-option value="experienced">Tengo experiencia regular</ion-select-option>
                <ion-select-option value="very_experienced">Soy muy experimentado</ion-select-option>
              </ion-select>
            </ion-item>

            <!-- Peso M√°ximo C√≥modo -->
            <ion-item 
              class="form-item" 
              *ngIf="medicalHistoryForm.get('weightExperience')?.value && medicalHistoryForm.get('weightExperience')?.value !== 'never'">
              <ion-label position="stacked">¬øCu√°l es el peso m√°ximo que puedes levantar c√≥modamente? (kg)</ion-label>
              <ion-input 
                formControlName="maxComfortableWeight" 
                type="number" 
                placeholder="Ej: 10, 20, 50..."
                min="0" 
                max="200">
              </ion-input>
            </ion-item>

            <!-- Nivel de Energ√≠a -->
            <ion-item class="form-item">
              <ion-label position="stacked">¬øC√≥mo describir√≠as tu nivel de energ√≠a general? *</ion-label>
              <ion-select formControlName="energyLevel" placeholder="Selecciona">
                <ion-select-option value="very_low">Muy bajo - Me canso f√°cilmente</ion-select-option>
                <ion-select-option value="low">Bajo - Me canso con actividades ligeras</ion-select-option>
                <ion-select-option value="moderate">Moderado - Nivel normal de energ√≠a</ion-select-option>
                <ion-select-option value="high">Alto - Tengo bastante energ√≠a</ion-select-option>
                <ion-select-option value="very_high">Muy alto - Siempre tengo energ√≠a</ion-select-option>
              </ion-select>
            </ion-item>
          </div>

          <!-- Condiciones M√©dicas B√°sicas (Tu c√≥digo existente) -->
          <div class="form-section">
            <h4>Condiciones M√©dicas</h4>
            
            <div class="dynamic-list">
              <h5>Condiciones Actuales</h5>
              <div *ngFor="let condition of getFormArray('medicalHistoryForm', 'currentConditions').controls; let i = index" class="dynamic-item">
                <ion-item class="form-item">
                  <ion-input 
                    [formControl]="$any(condition)" 
                    placeholder="Condici√≥n m√©dica">
                  </ion-input>
                  <ion-button 
                    fill="clear" 
                    slot="end" 
                    (click)="removeFromArray('medicalHistoryForm', 'currentConditions', i)">
                    <ion-icon name="trash-outline" color="danger"></ion-icon>
                  </ion-button>
                </ion-item>
              </div>
              <ion-button 
                fill="outline" 
                size="small" 
                (click)="addToArray('medicalHistoryForm', 'currentConditions')">
                <ion-icon name="add-outline" slot="start"></ion-icon>
                Agregar Condici√≥n
              </ion-button>
            </div>

            <div class="dynamic-list">
              <h5>Alergias</h5>
              <div *ngFor="let allergy of getFormArray('medicalHistoryForm', 'allergies').controls; let i = index" class="dynamic-item">
                <ion-item class="form-item">
                  <ion-input 
                    [formControl]="$any(allergy)" 
                    placeholder="Alergia">
                  </ion-input>
                  <ion-button 
                    fill="clear" 
                    slot="end" 
                    (click)="removeFromArray('medicalHistoryForm', 'allergies', i)">
                    <ion-icon name="trash-outline" color="danger"></ion-icon>
                  </ion-button>
                </ion-item>
              </div>
              <ion-button 
                fill="outline" 
                size="small" 
                (click)="addToArray('medicalHistoryForm', 'allergies')">
                <ion-icon name="add-outline" slot="start"></ion-icon>
                Agregar Alergia
              </ion-button>
            </div>

            <div class="dynamic-list">
              <h5>Medicamentos Actuales</h5>
              <div *ngFor="let medication of getFormArray('medicalHistoryForm', 'medications').controls; let i = index" class="dynamic-item">
                <ion-item class="form-item">
                  <ion-input 
                    [formControl]="$any(medication)" 
                    placeholder="Medicamento y dosis">
                  </ion-input>
                  <ion-button 
                    fill="clear" 
                    slot="end" 
                    (click)="removeFromArray('medicalHistoryForm', 'medications', i)">
                    <ion-icon name="trash-outline" color="danger"></ion-icon>
                  </ion-button>
                </ion-item>
              </div>
              <ion-button 
                fill="outline" 
                size="small" 
                (click)="addToArray('medicalHistoryForm', 'medications')">
                <ion-icon name="add-outline" slot="start"></ion-icon>
                Agregar Medicamento
              </ion-button>
            </div>
          </div>

          <!-- Evaluaciones M√©dicas -->
          <div class="form-section">
            <h4>Evaluaciones M√©dicas</h4>
            
            <!-- √öLTIMO CHEQUEO M√âDICO SIMPLE -->
              <ion-item class="form-item">
                <ion-label position="stacked">√öltimo Chequeo M√©dico</ion-label>
                <ion-input 
                  formControlName="lastMedicalCheckup" 
                  type="date"
                  [max]="maxDate.split('T')[0]"
                  placeholder="DD/MM/AAAA">
                </ion-input>
              </ion-item>

            <ion-item class="form-item">
              <ion-checkbox formControlName="doctorClearance"></ion-checkbox>
              <ion-label class="checkbox-label">
                Tengo autorizaci√≥n m√©dica para hacer ejercicio
              </ion-label>
            </ion-item>

            <ion-item class="form-item">
              <ion-label position="stacked">Notas del M√©dico</ion-label>
              <ion-textarea 
                formControlName="doctorNotes" 
                placeholder="Cualquier recomendaci√≥n espec√≠fica de tu m√©dico..."
                rows="3">
              </ion-textarea>
            </ion-item>
          </div>

          <div class="form-actions">
            <ion-button 
              type="submit" 
              expand="block" 
              [disabled]="isSaving"
              [color]="isAIReady ? 'success' : 'primary'">
              {{ isSaving ? 'Guardando...' : 'Guardar Historial M√©dico' }}
              <ion-spinner *ngIf="isSaving" slot="end"></ion-spinner>
              <ion-icon name="brain-outline" slot="end" *ngIf="isAIReady && !isSaving"></ion-icon>
            </ion-button>
          </div>
        </form>
      </ion-card-content>
    </ion-card>

    <!-- ===== SECCI√ìN OBJETIVOS FITNESS ===== -->
    <ion-card *ngIf="currentSection === 'goals'" class="section-card">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="trophy-outline"></ion-icon>
          Objetivos de Fitness
        </ion-card-title>
      </ion-card-header>
      
      <ion-card-content>
        <form [formGroup]="fitnessGoalsForm" (ngSubmit)="saveFitnessGoals()">
          
          <div class="form-section">
            <h4>Objetivos Principales *</h4>
            <p class="section-description">Selecciona tus objetivos principales (puedes elegir varios)</p>
            
            <div class="goals-grid">
              <ion-item 
                *ngFor="let goal of primaryGoalsOptions" 
                class="goal-item"
                [class.selected]="fitnessGoalsForm.get('primaryGoals')?.value?.includes(goal.value)">
                <ion-checkbox 
                  [checked]="fitnessGoalsForm.get('primaryGoals')?.value?.includes(goal.value)"
                  (ionChange)="toggleGoal(goal.value)">
                </ion-checkbox>
                <ion-label class="goal-label">{{ goal.label }}</ion-label>
              </ion-item>
            </div>
          </div>

          <div class="form-section">
            <h4>Objetivos Espec√≠ficos</h4>
            
            <div class="form-row">
              <ion-item class="form-item half">
                <ion-label position="stacked">Peso Objetivo (kg)</ion-label>
                <ion-input 
                  formControlName="targetWeight" 
                  type="number" 
                  placeholder="Ej: 65">
                </ion-input>
              </ion-item>

              <ion-item class="form-item half">
                <ion-label position="stacked">% Grasa Corporal Objetivo</ion-label>
                <ion-input 
                  formControlName="targetBodyFat" 
                  type="number" 
                  placeholder="Ej: 15">
                </ion-input>
              </ion-item>
            </div>
          </div>

          <div class="form-section">
            <h4>Preferencias de Entrenamiento</h4>
            
            <ion-item class="form-item">
              <ion-label position="stacked">Tipos de Ejercicio Preferidos</ion-label>
              <ion-select 
                formControlName="preferredWorkoutTypes" 
                multiple="true" 
                placeholder="Selecciona tipos de ejercicio">
                <ion-select-option value="strength">Fuerza</ion-select-option>
                <ion-select-option value="cardio">Cardio</ion-select-option>
                <ion-select-option value="flexibility">Flexibilidad</ion-select-option>
                <ion-select-option value="sports">Deportes</ion-select-option>
                <ion-select-option value="group_classes">Clases Grupales</ion-select-option>
              </ion-select>
            </ion-item>

            <div class="form-row">
              <ion-item class="form-item half">
                <ion-label position="stacked">Duraci√≥n Preferida (min)</ion-label>
                <ion-select formControlName="preferredWorkoutDuration" placeholder="Minutos">
                  <ion-select-option value="15">15 minutos</ion-select-option>
                  <ion-select-option value="30">30 minutos</ion-select-option>
                  <ion-select-option value="45">45 minutos</ion-select-option>
                  <ion-select-option value="60">60 minutos</ion-select-option>
                  <ion-select-option value="90">90 minutos</ion-select-option>
                </ion-select>
              </ion-item>

              <ion-item class="form-item half">
                <ion-label position="stacked">Frecuencia Semanal</ion-label>
                <ion-select formControlName="preferredWorkoutFrequency" placeholder="D√≠as/semana">
                  <ion-select-option value="2">2 d√≠as/semana</ion-select-option>
                  <ion-select-option value="3">3 d√≠as/semana</ion-select-option>
                  <ion-select-option value="4">4 d√≠as/semana</ion-select-option>
                  <ion-select-option value="5">5 d√≠as/semana</ion-select-option>
                  <ion-select-option value="6">6 d√≠as/semana</ion-select-option>
                  <ion-select-option value="7">7 d√≠as/semana</ion-select-option>
                </ion-select>
              </ion-item>
            </div>
          </div>

          <div class="form-actions">
            <ion-button 
              type="submit" 
              expand="block" 
              [disabled]="fitnessGoalsForm.invalid || isSaving">
              {{ isSaving ? 'Guardando...' : 'Guardar Objetivos' }}
              <ion-spinner *ngIf="isSaving" slot="end"></ion-spinner>
            </ion-button>
          </div>
        </form>
      </ion-card-content>
    </ion-card>

    <!-- ===== SECCI√ìN NIVEL FITNESS ===== -->
<ion-card *ngIf="currentSection === 'level'" class="section-card">
  <ion-card-header>
    <ion-card-title>
      <ion-icon name="barbell-outline"></ion-icon>
      Nivel de Fitness
    </ion-card-title>
  </ion-card-header>
  
  <ion-card-content>
    <form [formGroup]="fitnessLevelForm" (ngSubmit)="saveFitnessLevel()">
      
      <div class="form-section">
        <h4>Nivel General *</h4>
        <p class="section-description">¬øC√≥mo describir√≠as tu nivel actual de fitness?</p>
        
        <!-- ‚úÖ CORRECCI√ìN: ion-radio-group CON formControlName -->
        <ion-radio-group formControlName="overallLevel">
          <ion-item 
            *ngFor="let level of fitnessLevelOptions" 
            class="level-item"
            [class.selected]="fitnessLevelForm.get('overallLevel')?.value === level.value">
            <ion-radio 
              slot="start" 
              [value]="level.value">
            </ion-radio>
            <ion-label class="level-label">
              <h3>{{ level.label }}</h3>
              <p>{{ getLevelDescription(level.value) }}</p>
            </ion-label>
          </ion-item>
        </ion-radio-group>
      </div>

      <div class="form-section">
        <h4>Experiencia por Categor√≠a</h4>
        
        <ion-item class="form-item">
          <ion-label position="stacked">Entrenamiento de Fuerza</ion-label>
          <ion-select formControlName="strengthTraining" placeholder="Nivel">
            <ion-select-option 
              *ngFor="let exp of experienceLevelOptions" 
              [value]="exp.value">
              {{ exp.label }}
            </ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item class="form-item">
          <ion-label position="stacked">Entrenamiento Cardiovascular</ion-label>
          <ion-select formControlName="cardioTraining" placeholder="Nivel">
            <ion-select-option 
              *ngFor="let exp of experienceLevelOptions" 
              [value]="exp.value">
              {{ exp.label }}
            </ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item class="form-item">
          <ion-label position="stacked">Flexibilidad</ion-label>
          <ion-select formControlName="flexibilityTraining" placeholder="Nivel">
            <ion-select-option 
              *ngFor="let exp of experienceLevelOptions" 
              [value]="exp.value">
              {{ exp.label }}
            </ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item class="form-item">
          <ion-label position="stacked">Experiencia Deportiva</ion-label>
          <ion-select formControlName="sportsExperience" placeholder="Nivel">
            <ion-select-option 
              *ngFor="let exp of experienceLevelOptions" 
              [value]="exp.value">
              {{ exp.label }}
            </ion-select-option>
          </ion-select>
        </ion-item>
      </div>

      <div class="form-section">
        <h4>Experiencia Temporal</h4>
        
        <div class="form-row">
          <ion-item class="form-item half">
            <ion-label position="stacked">A√±os Entrenando</ion-label>
            <ion-input 
              formControlName="yearsOfTraining" 
              type="number" 
              placeholder="Ej: 2"
              min="0" 
              max="50">
            </ion-input>
          </ion-item>

          <ion-item class="form-item half">
            <ion-label position="stacked">Meses Adicionales</ion-label>
            <ion-input 
              formControlName="monthsOfTraining" 
              type="number" 
              placeholder="Ej: 6"
              min="0" 
              max="11">
            </ion-input>
          </ion-item>
        </div>

        <ion-item class="form-item">
          <ion-checkbox formControlName="previousGymExperience"></ion-checkbox>
          <ion-label class="checkbox-label">
            He entrenado en gimnasio anteriormente
          </ion-label>
        </ion-item>
      </div>

      <div class="form-actions">
        <ion-button 
          type="submit" 
          expand="block" 
          [disabled]="fitnessLevelForm.invalid || isSaving">
          {{ isSaving ? 'Guardando...' : 'Guardar Nivel de Fitness' }}
          <ion-spinner *ngIf="isSaving" slot="end"></ion-spinner>
        </ion-button>
      </div>
    </form>
  </ion-card-content>
</ion-card>

    <!-- ===== SECCI√ìN PREFERENCIAS ===== -->
    <ion-card *ngIf="currentSection === 'preferences'" class="section-card">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="settings-outline"></ion-icon>
          Preferencias de Entrenamiento
        </ion-card-title>
      </ion-card-header>
      
      <ion-card-content>
        <form [formGroup]="trainingPreferencesForm" (ngSubmit)="saveTrainingPreferences()">
          
          <div class="form-section">
            <h4>Disponibilidad</h4>
            
            <ion-item class="form-item">
              <ion-label position="stacked">D√≠as Disponibles</ion-label>
              <ion-select 
                formControlName="availableDays" 
                multiple="true" 
                placeholder="Selecciona d√≠as disponibles">
                <ion-select-option 
                  *ngFor="let day of daysOptions" 
                  [value]="day.value">
                  {{ day.label }}
                </ion-select-option>
              </ion-select>
            </ion-item>

            <ion-item class="form-item">
              <ion-label position="stacked">Horarios Preferidos</ion-label>
              <ion-select 
                formControlName="preferredTimeSlots" 
                multiple="true" 
                placeholder="Selecciona horarios">
                <ion-select-option value="early_morning">Madrugada (5-7 AM)</ion-select-option>
                <ion-select-option value="morning">Ma√±ana (7-11 AM)</ion-select-option>
                <ion-select-option value="afternoon">Tarde (11 AM-5 PM)</ion-select-option>
                <ion-select-option value="evening">Noche (5-9 PM)</ion-select-option>
                <ion-select-option value="late_evening">Noche tard√≠a (9+ PM)</ion-select-option>
              </ion-select>
            </ion-item>

            <ion-item class="form-item">
              <ion-label position="stacked">Duraci√≥n M√°xima por Sesi√≥n (min)</ion-label>
              <ion-select formControlName="maxSessionDuration" placeholder="Minutos m√°ximos">
                <ion-select-option value="30">30 minutos</ion-select-option>
                <ion-select-option value="45">45 minutos</ion-select-option>
                <ion-select-option value="60">60 minutos</ion-select-option>
                <ion-select-option value="90">90 minutos</ion-select-option>
                <ion-select-option value="120">120 minutos</ion-select-option>
              </ion-select>
            </ion-item>
          </div>

          <div class="form-section">
            <h4>Entorno y Equipamiento</h4>
            
            <ion-item class="form-item">
              <ion-label position="stacked">Entorno Preferido</ion-label>
              <ion-select 
                formControlName="preferredEnvironment" 
                multiple="true" 
                placeholder="Selecciona entornos">
                <ion-select-option value="home">Casa</ion-select-option>
                <ion-select-option value="gym">Gimnasio</ion-select-option>
                <ion-select-option value="outdoor">Aire libre</ion-select-option>
                <ion-select-option value="online">Online/Virtual</ion-select-option>
              </ion-select>
            </ion-item>

            <ion-item class="form-item">
              <ion-label position="stacked">Limitaciones de Espacio</ion-label>
              <ion-textarea 
                formControlName="spaceConstraints" 
                placeholder="Describe cualquier limitaci√≥n de espacio que tengas..."
                rows="2">
              </ion-textarea>
            </ion-item>
          </div>

          <div class="form-section">
            <h4>Preferencias de Estilo</h4>
            
            <ion-item class="form-item">
              <ion-label position="stacked">Intensidad Preferida</ion-label>
              <ion-select formControlName="preferredIntensity" placeholder="Nivel de intensidad">
                <ion-select-option value="low">Baja - Suave y relajado</ion-select-option>
                <ion-select-option value="moderate">Moderada - Equilibrado</ion-select-option>
                <ion-select-option value="high">Alta - Intenso y desafiante</ion-select-option>
                <ion-select-option value="variable">Variable - Depende del d√≠a</ion-select-option>
              </ion-select>
            </ion-item>

            <ion-item class="form-item">
              <ion-checkbox formControlName="needsMotivation"></ion-checkbox>
              <ion-label class="checkbox-label">
                Necesito motivaci√≥n y recordatorios frecuentes
              </ion-label>
            </ion-item>

            <ion-item class="form-item">
              <ion-checkbox formControlName="prefersGroupWorkouts"></ion-checkbox>
              <ion-label class="checkbox-label">
                Prefiero entrenamientos grupales
              </ion-label>
            </ion-item>
          </div>

          <!-- Preferencias de Retroalimentaci√≥n -->
          <div class="form-section" formGroupName="feedbackPreferences">
            <h4>Preferencias de Retroalimentaci√≥n</h4>
            
            <ion-item class="form-item">
              <ion-checkbox formControlName="audioFeedback"></ion-checkbox>
              <ion-label class="checkbox-label">
                Retroalimentaci√≥n por audio/voz
              </ion-label>
            </ion-item>

            <ion-item class="form-item">
              <ion-checkbox formControlName="visualFeedback"></ion-checkbox>
              <ion-label class="checkbox-label">
                Retroalimentaci√≥n visual en pantalla
              </ion-label>
            </ion-item>

            <ion-item class="form-item">
              <ion-checkbox formControlName="realTimeCorrections"></ion-checkbox>
              <ion-label class="checkbox-label">
                Correcciones en tiempo real
              </ion-label>
            </ion-item>

            <ion-item class="form-item">
              <ion-checkbox formControlName="postWorkoutAnalysis"></ion-checkbox>
              <ion-label class="checkbox-label">
                An√°lisis post-entrenamiento
              </ion-label>
            </ion-item>
          </div>

          <div class="form-actions">
            <ion-button 
              type="submit" 
              expand="block" 
              [disabled]="isSaving">
              {{ isSaving ? 'Guardando...' : 'Guardar Preferencias' }}
              <ion-spinner *ngIf="isSaving" slot="end"></ion-spinner>
            </ion-button>
          </div>
        </form>
      </ion-card-content>
    </ion-card>

   
  </div>
</ion-content>