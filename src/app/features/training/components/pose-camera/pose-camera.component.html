<!-- src/app/features/training/components/pose-camera/pose-camera.component.html -->
<!-- ‚úÖ TEMPLATE CORREGIDO Y OPTIMIZADO -->

<div class="camera-container">
  
  <!-- üîÑ ESTADO DE CARGA -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="loading-spinner">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
    </div>
    <div class="loading-text">{{ getStatusMessage() }}</div>
    <div class="loading-subtitle" *ngIf="initializationAttempts > 0">
      Intento {{ initializationAttempts }} de {{ maxInitializationAttempts }}
    </div>
  </div>

  <!-- ‚ùå ESTADO DE ERROR -->
  <div class="error-overlay" *ngIf="error && !isLoading">
    <div class="error-content">
      <ion-icon name="camera-outline" class="error-icon"></ion-icon>
      <div class="error-title">Error de Inicializaci√≥n</div>
      <div class="error-message">{{ error }}</div>
      <ion-button 
        class="retry-button" 
        fill="solid" 
        color="primary"
        (click)="startCamera()">
        <ion-icon name="refresh-outline" slot="start"></ion-icon>
        REINTENTAR
      </ion-button>
    </div>
  </div>

  <!-- ‚úÖ ELEMENTOS DE C√ÅMARA -->
  <div class="camera-content" 
       [class.hidden]="isLoading || !!error">
    
    <!-- üìπ VIDEO - SIEMPRE EN DOM PARA VIEWCHILD -->
    <video 
      #videoElement 
      class="video-element"
      autoplay 
      muted 
      playsinline>
    </video>
    
    <!-- üé® CANVAS ESQUELETO -->
    <canvas 
      #canvasElement 
      class="canvas-element"
      [class.hidden]="!showSkeleton">
    </canvas>
    
    <!-- üö® CANVAS OVERLAY ERRORES -->
    <canvas 
      #overlayElement 
      class="overlay-element">
    </canvas>
    
  </div>

  <!-- üé® INTERFAZ DE USUARIO -->
  <div class="ui-overlay" *ngIf="!isLoading && !error && isInitialized">
    
    <!-- üìä PANEL DE ESTAD√çSTICAS -->
    <div class="stats-panel">
      <div class="stats-header">
        <ion-icon name="analytics-outline"></ion-icon>
        <span class="stats-title">Estad√≠sticas</span>
        <div class="connection-indicator" [ngClass]="getStatusColor()">
          <div class="pulse-dot"></div>
          <span class="connection-text">{{ getStatusMessage() }}</span>
        </div>
      </div>
      
      <div class="stats-content">
        <div class="stat-item">
          <span class="stat-label">FPS:</span>
          <span class="stat-value" [ngClass]="{'stat-warning': fps < 20}">{{ fps }}</span>
        </div>
        
        <div class="stat-item">
          <span class="stat-label">Repeticiones:</span>
          <span class="stat-value stat-primary">{{ repetitionCount }}</span>
        </div>
        
        <div class="stat-item">
          <span class="stat-label">Fase:</span>
          <span class="stat-value">{{ getCurrentPhaseText() }}</span>
        </div>
        
        <div class="stat-item" *ngIf="hasActiveErrors()">
          <span class="stat-label">Errores:</span>
          <span class="stat-value stat-danger">{{ currentErrors.length }}</span>
        </div>
      </div>
    </div>

    <!-- üéÆ CONTROLES PRINCIPALES -->
    <div class="controls-panel">
      <div class="controls-header">
        <ion-icon name="settings-outline"></ion-icon>
        <span>Controles</span>
      </div>
      
      <div class="controls-content">
        <!-- Control de Ejercicio -->
        <div class="control-group">
          <label class="control-label">Ejercicio:</label>
          <ion-select 
            [value]="exerciseType" 
            (ionChange)="setExerciseType($event.detail.value)"
            interface="popover"
            placeholder="Seleccionar ejercicio">
            <ion-select-option value="squats">Sentadillas</ion-select-option>
            <ion-select-option value="pushups">Flexiones</ion-select-option>
            <ion-select-option value="plank">Plancha</ion-select-option>
            <ion-select-option value="lunges">Estocadas</ion-select-option>
          </ion-select>
        </div>

        <!-- Botones de Toggle -->
        <div class="toggle-buttons">
          <ion-button 
            fill="clear" 
            size="small"
            [color]="enableErrorDetection ? 'success' : 'medium'"
            (click)="toggleErrorDetection()">
            <ion-icon 
              [name]="enableErrorDetection ? 'eye-outline' : 'eye-off-outline'" 
              slot="start">
            </ion-icon>
            <span>{{ enableErrorDetection ? 'Detecci√≥n ON' : 'Detecci√≥n OFF' }}</span>
          </ion-button>

          <ion-button 
            fill="clear" 
            size="small"
            [color]="showSkeleton ? 'success' : 'medium'"
            (click)="toggleSkeleton()">
            <ion-icon 
              [name]="showSkeleton ? 'person-outline' : 'person-remove-outline'" 
              slot="start">
            </ion-icon>
            <span>{{ showSkeleton ? 'Esqueleto ON' : 'Esqueleto OFF' }}</span>
          </ion-button>

          <ion-button 
            fill="clear" 
            size="small"
            [color]="enableAudio ? 'success' : 'medium'"
            (click)="toggleAudio()">
            <ion-icon 
              [name]="enableAudio ? 'volume-high-outline' : 'volume-mute-outline'" 
              slot="start">
            </ion-icon>
            <span>{{ enableAudio ? 'Audio ON' : 'Audio OFF' }}</span>
          </ion-button>
        </div>

        <!-- Botones de Acci√≥n -->
        <div class="action-buttons">
          <ion-button 
            fill="outline" 
            size="small" 
            color="warning"
            (click)="resetRepetitions()">
            <ion-icon name="refresh-outline" slot="start"></ion-icon>
            Reset
          </ion-button>

          <ion-button 
            fill="outline" 
            size="small" 
            color="secondary"
            (click)="testAudio()"
            [disabled]="!enableAudio">
            <ion-icon name="volume-high-outline" slot="start"></ion-icon>
            Test Audio
          </ion-button>

          <ion-button 
            fill="solid" 
            size="small" 
            color="danger"
            (click)="stopCamera()">
            <ion-icon name="stop-outline" slot="start"></ion-icon>
            Parar
          </ion-button>
        </div>
      </div>
    </div>

    <!-- üí¨ PANEL DE MOTIVACI√ìN -->
    <div class="motivation-panel" *ngIf="repetitionCount > 0">
      <div class="motivation-content">
        <ion-icon name="fitness-outline" class="motivation-icon"></ion-icon>
        <span class="motivation-text">{{ getMotivationText() }}</span>
      </div>
    </div>

    <!-- üö® ALERTAS DE ERRORES EN TIEMPO REAL CON COLORES -->
<div class="error-alerts" *ngIf="hasActiveErrors() && enableErrorDetection">
  <div 
    class="error-alert" 
    *ngFor="let error of getActiveErrors(); trackBy: trackErrorById"
    [ngClass]="getAlertClass(error.severity)">
    
    <div class="error-content">
      <div class="error-header">
        <ion-icon [name]="getAlertIcon(error.severity)" class="error-icon"></ion-icon>
        <span class="error-title">{{ getAlertTitle(error.severity) }}</span>
        <ion-icon 
          [name]="enableAudio ? 'volume-high-outline' : 'volume-mute-outline'" 
          class="audio-indicator">
        </ion-icon>
      </div>
      
      <div class="error-description">{{ error.description }}</div>
      <div class="error-recommendation">
        <ion-icon name="bulb-outline" class="recommendation-icon"></ion-icon>
        {{ error.recommendation }}
      </div>
    </div>
    
    <div class="error-severity">
      <div class="severity-bar">
        <div 
          class="severity-fill" 
          [style.width]="(error.severity * 10) + '%'"
          [ngClass]="getSeverityBarClass(error.severity)">
        </div>
      </div>
      <span class="severity-text">{{ getSeverityText(error.severity) }}</span>
    </div>
  </div>
</div>

    <!-- üîß PANEL DE DEBUG (SOLO EN DESARROLLO) -->
    <div class="debug-panel" *ngIf="false">
      <details>
        <summary>Debug Info</summary>
        <div class="debug-content">
          <div class="debug-item">
            <strong>Current Pose:</strong> {{ !!currentPose }}
          </div>
          <div class="debug-item">
            <strong>Current Angles:</strong> {{ !!currentAngles }}
          </div>
          <div class="debug-item">
            <strong>Audio Playing:</strong> {{ isPlayingAudio }}
          </div>
          <div class="debug-item">
            <strong>Exercise:</strong> {{ exerciseType }}
          </div>
          <div class="debug-item">
            <strong>Phase:</strong> {{ currentPhase }}
          </div>
        </div>
      </details>
    </div>

  </div>

</div>