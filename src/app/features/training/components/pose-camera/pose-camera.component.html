<!-- src/app/features/training/components/pose-camera/pose-camera.component.html -->
<!-- ‚úÖ TEMPLATE ACTUALIZADO CON M√âTRICAS CIENT√çFICAS -->

<div class="camera-container">
  
  <!-- üîÑ ESTADO DE CARGA -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="loading-spinner"></div>
    <div class="loading-text">Iniciando c√°mara...</div>
    <div class="loading-subtitle" *ngIf="initializationAttempts > 0">
      Intento {{ initializationAttempts }} de {{ maxInitializationAttempts }}
    </div>
  </div>

  <!-- ‚ùå ESTADO DE ERROR -->
  <div class="error-overlay" *ngIf="error && !isLoading">
    <div class="error-icon">üì∑</div>
    <div class="error-title">Error de Inicializaci√≥n</div>
    <div class="error-message">{{ error }}</div>
    <button class="retry-button" (click)="startCamera()">
      REINTENTAR
    </button>
  </div>

  <!-- ‚úÖ ELEMENTOS DE C√ÅMARA - SIEMPRE PRESENTES PARA VIEWCHILD STATIC -->
  <div class="camera-content" 
       [style.display]="(!isLoading && !error && isInitialized) ? 'block' : 'none'">
    
    <!-- üìπ VIDEO - SIEMPRE EN DOM -->
    <video 
      #videoElement 
      class="video-element"
      autoplay 
      muted 
      playsinline>
    </video>
    
    <!-- üé® CANVAS - SIEMPRE EN DOM -->
    <canvas 
      #canvasElement 
      class="canvas-element">
    </canvas>
    
    <!-- üéØ OVERLAY - SIEMPRE EN DOM -->
    <canvas 
      #overlayElement 
      class="overlay-element">
    </canvas>
    
  </div>

  <!-- üé® UI PROFESIONAL - SOLO CUANDO EST√Å ACTIVO -->
  <div class="ui-overlay" *ngIf="!isLoading && !error && isInitialized">
    
    <!-- üìä PANEL DE ESTAD√çSTICAS COMPACTO -->
    <div class="stats-panel" *ngIf="fps > 0">
      <div class="stats-header">
        <div class="stats-title">
          <ion-icon name="analytics-outline"></ion-icon>
          <span>Estad√≠sticas en Vivo</span>
        </div>
        <div class="connection-indicator" [ngClass]="fps > 20 ? 'connected' : 'poor'">
          <div class="pulse-dot"></div>
          <span>{{ fps > 20 ? 'Excelente' : 'Conectando' }}</span>
        </div>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <ion-icon name="speedometer-outline"></ion-icon>
          <div class="stat-value">{{ fps }}</div>
          <div class="stat-label">FPS</div>
        </div>
        
        <div class="stat-card">
          <ion-icon name="fitness-outline"></ion-icon>
          <div class="stat-value">{{ repetitionCount }}</div>
          <div class="stat-label">REPS</div>
        </div>
        
        <div class="stat-card">
          <ion-icon name="trophy-outline"></ion-icon>
          <div class="stat-value" [ngClass]="getQualityClass()">{{ currentQuality }}%</div>
          <div class="stat-label">CALIDAD</div>
        </div>
        
        <div class="stat-card">
          <ion-icon name="pulse-outline"></ion-icon>
          <div class="stat-value">{{ getPhaseText() }}</div>
          <div class="stat-label">FASE</div>
        </div>
      </div>
      
      <div class="progress-bar" *ngIf="repetitionCount > 0">
        <div class="progress-fill" [style.width.%]="Math.min(repetitionCount * 10, 100)"></div>
      </div>
    </div>

    <!-- ‚úÖ NUEVO: PANEL DE M√âTRICAS CIENT√çFICAS -->
    <div class="scientific-panel" *ngIf="showScientificMetrics && precisionMetrics">
      <div class="scientific-header">
        <div class="scientific-title">
          <ion-icon name="flask-outline"></ion-icon>
          <span>M√©tricas Cient√≠ficas</span>
        </div>
        <div class="validation-status" [ngClass]="isScientificallyValidated() ? 'validated' : 'pending'">
          <ion-icon [name]="isScientificallyValidated() ? 'checkmark-circle' : 'time'"></ion-icon>
          <span>{{ isScientificallyValidated() ? 'Validado' : 'Validando' }}</span>
        </div>
      </div>
      
      <div class="scientific-grid">
        <div class="metric-card precision" [ngClass]="getPrecisionStatus()">
          <ion-icon name="target-outline"></ion-icon>
          <div class="metric-value">{{ precisionMetrics.overallPrecision.toFixed(1) }}%</div>
          <div class="metric-label">Precisi√≥n</div>
        </div>
        
        <div class="metric-card angular" [ngClass]="precisionMetrics.angularAccuracy > 90 ? 'excellent' : 'good'">
          <ion-icon name="git-compare-outline"></ion-icon>
          <div class="metric-value">{{ precisionMetrics.angularAccuracy.toFixed(1) }}¬∞</div>
          <div class="metric-label">Angular</div>
        </div>
        
        <div class="metric-card stability" [ngClass]="precisionMetrics.frameStability > 80 ? 'excellent' : 'good'">
          <ion-icon name="trending-up-outline"></ion-icon>
          <div class="metric-value">{{ precisionMetrics.frameStability.toFixed(0) }}%</div>
          <div class="metric-label">Estabilidad</div>
        </div>
        
        <div class="metric-card correlation" [ngClass]="precisionMetrics.correlationCoefficient > 85 ? 'excellent' : 'good'">
          <ion-icon name="stats-chart-outline"></ion-icon>
          <div class="metric-value">{{ precisionMetrics.correlationCoefficient.toFixed(0) }}%</div>
          <div class="metric-label">Correlaci√≥n</div>
        </div>
      </div>
      
      <!-- Validaci√≥n cient√≠fica detallada -->
      <div class="validation-details" *ngIf="scientificValidation">
        <div class="validation-text">{{ getValidationDetails() }}</div>
      </div>
    </div>

    <!-- ‚úÖ NUEVO: PANEL DE RENDIMIENTO -->
    <div class="performance-panel" *ngIf="showScientificMetrics && performanceMetrics">
      <div class="performance-header">
        <div class="performance-title">
          <ion-icon name="speedometer-outline"></ion-icon>
          <span>Rendimiento</span>
        </div>
        <div class="performance-status" [ngClass]="getPerformanceStatus()">
          <div class="status-dot"></div>
          <span>{{ getPerformanceStatus() | titlecase }}</span>
        </div>
      </div>
      
      <div class="performance-metrics">
        <div class="performance-item">
          <span class="perf-label">Latencia</span>
          <span class="perf-value">{{ performanceMetrics.latency }}ms</span>
        </div>
        <div class="performance-item">
          <span class="perf-label">CPU</span>
          <span class="perf-value">{{ performanceMetrics.cpuUsage }}%</span>
        </div>
        <div class="performance-item">
          <span class="perf-label">Memoria</span>
          <span class="perf-value">{{ performanceMetrics.memoryUsage }}MB</span>
        </div>
        <div class="performance-item">
          <span class="perf-label">Frames perdidos</span>
          <span class="perf-value">{{ performanceMetrics.frameDrops }}</span>
        </div>
      </div>
    </div>

    <!-- üîô BOT√ìN DE RETROCESO EN ESQUINA SUPERIOR -->
    <div class="back-button-container">
      <button class="back-btn-top" (click)="goBackToExercises()">
        <div class="back-icon">
          <ion-icon name="arrow-back"></ion-icon>
        </div>
        <span>Volver</span>
      </button>
    </div>

    <!-- üéÆ CONTROLES PROFESIONALES EXPANDIDOS -->
    <div class="professional-controls">
      
      <div class="control-group">
        
        <!-- Bot√≥n Esqueleto -->
        <button class="pro-control-btn skeleton-btn" 
                (click)="toggleSkeleton()"
                [class.active]="showSkeleton">
          <div class="btn-icon">
            <ion-icon [name]="showSkeleton ? 'eye' : 'eye-off'"></ion-icon>
          </div>
          <div class="btn-label">Esqueleto</div>
          <div class="btn-indicator" [class.on]="showSkeleton"></div>
        </button>
        
        <!-- ‚úÖ NUEVO: Bot√≥n M√©tricas Cient√≠ficas -->
        <button class="pro-control-btn metrics-btn" 
                (click)="toggleScientificMetrics()"
                [class.active]="showScientificMetrics">
          <div class="btn-icon">
            <ion-icon name="flask-outline"></ion-icon>
          </div>
          <div class="btn-label">Cient√≠fico</div>
          <div class="btn-indicator" [class.on]="showScientificMetrics"></div>
        </button>
        
        <!-- ‚úÖ NUEVO: Bot√≥n Calibraci√≥n -->
        <button class="pro-control-btn calibration-btn" 
                (click)="performCalibration()">
          <div class="btn-icon">
            <ion-icon name="compass-outline"></ion-icon>
          </div>
          <div class="btn-label">Calibrar</div>
        </button>
        
        <!-- Bot√≥n Reset -->
        <button class="pro-control-btn reset-btn" (click)="resetSession()">
          <div class="btn-icon">
            <ion-icon name="refresh-outline"></ion-icon>
          </div>
          <div class="btn-label">Reiniciar</div>
        </button>
        
        <!-- Bot√≥n Pausa/Play -->
        <button class="pro-control-btn pause-btn" (click)="togglePause()">
          <div class="btn-icon">
            <ion-icon [name]="isPaused ? 'play' : 'pause'"></ion-icon>
          </div>
          <div class="btn-label">{{ isPaused ? 'Continuar' : 'Pausar' }}</div>
        </button>
        
        <!-- ‚úÖ NUEVO: Bot√≥n Exportar -->
        <button class="pro-control-btn export-btn" 
                (click)="exportSessionData()">
          <div class="btn-icon">
            <ion-icon name="download-outline"></ion-icon>
          </div>
          <div class="btn-label">Exportar</div>
        </button>
        
      </div>
      
      <!-- Bot√≥n de Finalizar Sesi√≥n -->
      <button class="exit-btn" (click)="stopCamera()">
        <div class="exit-icon">
          <ion-icon name="close"></ion-icon>
        </div>
        <span>Finalizar Sesi√≥n</span>
      </button>
    </div>

    <!-- ‚ö†Ô∏è ALERTAS DE ERRORES MEJORADAS -->
    <div class="error-notifications" *ngIf="currentErrors.length > 0">
      <div *ngFor="let error of currentErrors.slice(0, 2); trackBy: trackByErrorType" 
           class="error-notification"
           [ngClass]="'severity-' + error.severity">
        <div class="error-icon">
          <ion-icon name="warning"></ion-icon>
        </div>
        <div class="error-content">
          <div class="error-title">Correcci√≥n de Postura</div>
          <div class="error-message">{{ error.description }}</div>
          <div class="error-recommendation">üí° {{ error.recommendation }}</div>
          <div class="error-confidence" *ngIf="error.confidence">
            Confianza: {{ (error.confidence * 100).toFixed(0) }}%
          </div>
        </div>
        <div class="error-severity">
          <div class="severity-indicator" [style.width.%]="error.severity * 10"></div>
        </div>
      </div>
    </div>
    
    <!-- üéØ OBJETIVO DE REPETICIONES -->
    <div class="rep-target" *ngIf="repetitionCount > 0">
      <div class="target-circle">
        <svg width="80" height="80" class="target-progress">
          <circle cx="40" cy="40" r="35" 
                  stroke="rgba(255,255,255,0.2)" 
                  stroke-width="3" 
                  fill="none"/>
          <circle cx="40" cy="40" r="35" 
                  stroke="#00d4ff" 
                  stroke-width="3" 
                  fill="none"
                  stroke-linecap="round"
                  [style.stroke-dasharray]="getCircleProgress()"
                  style="transform: rotate(-90deg); transform-origin: center;"/>
        </svg>
        <div class="target-content">
          <div class="target-number">{{ repetitionCount }}</div>
          <div class="target-label">/ 10</div>
        </div>
      </div>
    </div>

    <!-- ‚úÖ NUEVO: INDICADOR DE ESTADO CIENT√çFICO -->
    <div class="scientific-status" *ngIf="useEnhancedAnalysis && precisionMetrics">
      <div class="status-indicator" [ngClass]="getPrecisionStatus()">
        <ion-icon name="checkmark-circle" *ngIf="isScientificallyValidated()"></ion-icon>
        <ion-icon name="time" *ngIf="!isScientificallyValidated()"></ion-icon>
      </div>
      <div class="status-text">
        <div class="status-label">Validaci√≥n Cient√≠fica</div>
        <div class="status-value">{{ precisionMetrics.overallPrecision.toFixed(1) }}% precisi√≥n</div>
      </div>
    </div>
    
  </div>

</div>