<!-- src/app/tab2/tab2.page.html -->
<!-- TAB2 ULTRA LIMPIO - CERO DUPLICADOS -->

<ion-header [translucent]="true" *ngIf="!showCamera">
  <ion-toolbar color="dark" class="custom-toolbar">
    <ion-title class="custom-title">Entrenamiento IA</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="training-content">
  <!-- Background overlay -->
  <div class="background-overlay" [class.training-active]="showCamera"></div>
  
  <!-- VISTA SELECCIÓN DE EJERCICIO -->
  <div class="exercise-selection" *ngIf="!showCamera">
    
    <!-- Saludo usuario -->
    <div class="welcome-section" *ngIf="user">
      <div class="welcome-content">
        <div class="user-avatar">
          <img *ngIf="user.photoURL" [src]="user.photoURL" [alt]="user.displayName">
          <div *ngIf="!user.photoURL" class="avatar-placeholder">
            <ion-icon name="person"></ion-icon>
          </div>
        </div>
        <div class="welcome-text">
          <h1 class="welcome-title">¡Hola, {{ user.displayName }}!</h1>
          <p class="welcome-subtitle">Selecciona un ejercicio para comenzar tu entrenamiento con IA</p>
          <div class="ai-badge">
            <ion-icon name="hardware-chip-outline"></ion-icon>
            <span>POWERED BY AI</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Estadísticas hoy -->
    <div class="stats-card-enhanced">
      <div class="stats-header">
        <h3 class="stats-title">
          <ion-icon name="today-outline"></ion-icon>
          Estadísticas de Hoy
        </h3>
        <div class="stats-date">Hoy</div>
      </div>
      
      <div class="stats-grid-enhanced">
        <div class="stat-item-enhanced">
          <div class="stat-icon-enhanced">
            <ion-icon name="time-outline"></ion-icon>
          </div>
          <div class="stat-content">
            <span class="stat-label-enhanced">Tiempo</span>
            <span class="stat-value-enhanced">{{ todayStats.duration }}</span>
          </div>
        </div>

        <div class="stat-item-enhanced">
          <div class="stat-icon-enhanced">
            <ion-icon name="fitness-outline"></ion-icon>
          </div>
          <div class="stat-content">
            <span class="stat-label-enhanced">Repeticiones</span>
            <span class="stat-value-enhanced">{{ todayStats.repetitions }}</span>
          </div>
        </div>

        <div class="stat-item-enhanced">
          <div class="stat-icon-enhanced">
            <ion-icon name="bulb-outline"></ion-icon>
          </div>
          <div class="stat-content">
            <span class="stat-label-enhanced">Sugerencias</span>
            <span class="stat-value-enhanced">{{ todayStats.suggestions }}</span>
          </div>
        </div>

        <div class="stat-item-enhanced">
          <div class="stat-icon-enhanced">
            <ion-icon name="checkmark-circle-outline"></ion-icon>
          </div>
          <div class="stat-content">
            <span class="stat-label-enhanced">Correcciones</span>
            <span class="stat-value-enhanced">{{ todayStats.corrections }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Selección ejercicios -->
    <div class="exercises-section">
      <div class="section-header">
        <h3 class="section-title">
          <ion-icon name="barbell-outline"></ion-icon>
          Ejercicios Disponibles
        </h3>
        <div class="section-subtitle">Selecciona tu entrenamiento favorito</div>
      </div>

      <div class="exercises-grid-enhanced">
        <div class="exercise-card" 
             *ngFor="let exercise of availableExercises; let i = index"
             [class.selected]="exercise.type === currentExercise"
             [class.featured]="i === 0"
             (click)="selectExercise(exercise.type)">
          
          <div class="exercise-header">
            <div class="exercise-icon-wrapper">
              <div class="exercise-icon-bg"></div>
              <ion-icon [name]="exercise.icon" class="exercise-icon"></ion-icon>
            </div>
            <div class="exercise-difficulty">
              <span class="difficulty-badge">{{ exercise.difficulty }}</span>
            </div>
          </div>

          <div class="exercise-content">
            <h4 class="exercise-name">{{ exercise.name }}</h4>
            <p class="exercise-description">{{ exercise.description }}</p>
            
            <div class="exercise-stats">
              <div class="exercise-stat">
                <ion-icon name="flash-outline"></ion-icon>
                <span>IA Activa</span>
              </div>
              <div class="exercise-stat">
                <ion-icon name="eye-outline"></ion-icon>
                <span>Tiempo Real</span>
              </div>
            </div>
          </div>

          <div class="exercise-selection-indicator" *ngIf="exercise.type === currentExercise">
            <ion-icon name="checkmark-circle"></ion-icon>
          </div>
        </div>
      </div>
    </div>

    <!-- Configuraciones -->
    <div class="settings-section">
      <div class="section-header">
        <h3 class="section-title">
          <ion-icon name="options-outline"></ion-icon>
          Configuraciones
        </h3>
      </div>

      <div class="settings-grid">
        <div class="setting-card" [class.active]="audioEnabled" (click)="toggleAudio()">
          <div class="setting-icon">
            <ion-icon name="volume-high-outline"></ion-icon>
          </div>
          <div class="setting-content">
            <span class="setting-label">Audio</span>
            <span class="setting-description">Retroalimentación por voz</span>
          </div>
          <div class="setting-toggle">
            <ion-toggle [checked]="audioEnabled" (ionChange)="toggleAudio()"></ion-toggle>
          </div>
        </div>

        <div class="setting-card" [class.active]="detectionEnabled" (click)="toggleDetection()">
          <div class="setting-icon">
            <ion-icon name="scan-outline"></ion-icon>
          </div>
          <div class="setting-content">
            <span class="setting-label">Detección IA</span>
            <span class="setting-description">Análisis postural automático</span>
          </div>
          <div class="setting-toggle">
            <ion-toggle [checked]="detectionEnabled" (ionChange)="toggleDetection()"></ion-toggle>
          </div>
        </div>

        <div class="setting-card" [class.active]="skeletonVisible" (click)="toggleSkeleton()">
          <div class="setting-icon">
            <ion-icon name="body-outline"></ion-icon>
          </div>
          <div class="setting-content">
            <span class="setting-label">Esqueleto Visual</span>
            <span class="setting-description">Mostrar puntos corporales</span>
          </div>
          <div class="setting-toggle">
            <ion-toggle [checked]="skeletonVisible" (ionChange)="toggleSkeleton()"></ion-toggle>
          </div>
        </div>
      </div>
    </div>

    <!-- Botón inicio -->
    <div class="start-training-section">
      <div class="start-button-container">
        <ion-button 
          expand="block" 
          size="large"
          class="start-training-btn"
          [disabled]="!currentExercise"
          (click)="startTraining()">
          
          <div class="start-button-content">
            <ion-icon name="play-circle-outline" class="start-icon"></ion-icon>
            <div class="start-text">
              <span class="start-label">Iniciar Entrenamiento</span>
              <span class="start-exercise">{{ getExerciseName() }}</span>
            </div>
            <div class="start-indicator">
              <ion-icon name="chevron-forward-outline"></ion-icon>
            </div>
          </div>
        </ion-button>
      </div>

      <div class="training-tips">
        <div class="tip-item">
          <ion-icon name="checkmark-circle-outline"></ion-icon>
          <span>Mantén buena iluminación</span>
        </div>
        <div class="tip-item">
          <ion-icon name="checkmark-circle-outline"></ion-icon>
          <span>Asegúrate de tener espacio suficiente</span>
        </div>
        <div class="tip-item">
          <ion-icon name="checkmark-circle-outline"></ion-icon>
          <span>La IA analizará tu postura en tiempo real</span>
        </div>
      </div>
    </div>
  </div>

  <!-- VISTA ENTRENAMIENTO ULTRA LIMPIA - CERO DUPLICADOS -->
  <div class="training-view-ultra-clean" *ngIf="showCamera">
    
    <!-- Header mínimo: SOLO botón stop -->
    <div class="training-header-ultra">
      <div class="header-spacer"></div>
      <div class="header-spacer"></div>
      <ion-button fill="clear" size="small" (click)="stopTraining()" class="stop-btn-ultra">
        <ion-icon name="stop-outline"></ion-icon>
      </ion-button>
    </div>

    <!-- Cámara PROTAGONISTA -->
    <div class="camera-zone-ultra">
      <app-pose-camera 
        [exerciseType]="currentExercise"
        [enableAudio]="audioEnabled"
        [enableErrorDetection]="detectionEnabled" 
        [showSkeleton]="skeletonVisible"
        (errorDetected)="onErrorDetected($event)"
        (repetitionCounted)="onRepetitionCounted($event)">
      </app-pose-camera>
    </div>

    <!-- Stats bottom ÚNICOS -->
    <div class="stats-bottom-ultra">
      <div class="stat-ultra">
        <span class="stat-number-ultra">{{ sessionData.repetitions }}</span>
        <span class="stat-label-ultra">REPS</span>
      </div>
      <div class="stat-ultra">
        <span class="stat-number-ultra">{{ formatDuration(sessionStats.duration) }}</span>
        <span class="stat-label-ultra">TIEMPO</span>
      </div>
      <div class="stat-ultra">
        <span class="stat-number-ultra">{{ sessionStats.errorsDetected }}</span>
        <span class="stat-label-ultra">ERRORES</span>
      </div>
    </div>

  </div>

</ion-content>